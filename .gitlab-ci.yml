# GitLab CI/CD Pipeline for Mirror Maestro
#
# This pipeline provides the same functionality as the GitHub Actions workflows:
# - tests.yml: Run pytest on Python 3.11 and 3.12
# - release.yml: Build and publish Docker images on version tags
# - e2e-live-gitlab.yml: Manual E2E tests against live GitLab instances
#
# GitHub will ignore this file, allowing both CI/CD systems to coexist.
#
# AIR-GAPPED / RESTRICTED NETWORK SUPPORT:
# Configure these CI/CD variables for environments without internet access:
# - CI_DOCKER_REGISTRY: Local Docker registry mirror (e.g., "harbor.company.com/proxy/")
# - CI_PIP_INDEX_URL: Local PyPI mirror (e.g., "http://nexus.company.com/repository/pypi-proxy/simple")
# - CI_PIP_TRUSTED_HOST: Trusted host for HTTP PyPI mirror (e.g., "nexus.company.com")
# - DOCKER_REGISTRY: Docker registry for base images (passed to Dockerfile build)
# - APT_MIRROR: APT package mirror (passed to Dockerfile build)
# - PIP_INDEX_URL: PyPI mirror (passed to Dockerfile build)
# - PIP_TRUSTED_HOST: Trusted host (passed to Dockerfile build)
#
# NOTE: This pipeline uses Ubuntu-based images to match the application Dockerfile.
# CI jobs use python:3.11-slim (Ubuntu), docker:24-dind (Alpine), and release-cli (Alpine).
# In air-gapped environments, you need Ubuntu APT mirrors and Alpine APK mirrors.
#
# See docs/GITLAB_CICD.md for detailed configuration instructions.

stages:
  - test
  - build
  - release

# Variables for local mirror support
variables:
  # CI job image registry (defaults to Docker Hub if not set)
  CI_DOCKER_REGISTRY: "${CI_DOCKER_REGISTRY}"
  # CI pip configuration (defaults to PyPI if not set)
  CI_PIP_INDEX_URL: "${CI_PIP_INDEX_URL}"
  CI_PIP_TRUSTED_HOST: "${CI_PIP_TRUSTED_HOST}"

# Default settings for all jobs
default:
  # Use Alpine-based Python images to reduce mirror dependencies in air-gapped environments
  # Alpine images only need Alpine APK repos, matching docker:24 and release-cli images
  # Alternative: Use CI_PYTHON_IMAGE variable to override (e.g., python:3.11-slim for Debian)
  image: ${CI_DOCKER_REGISTRY}${CI_PYTHON_IMAGE:-python:3.11-alpine}
  before_script:
    # Install pip if using Alpine (not included by default)
    - |
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache gcc musl-dev libffi-dev
      fi
    # Configure pip to use local mirror if set
    - |
      if [ -n "$CI_PIP_INDEX_URL" ]; then
        python -m pip install --upgrade pip --index-url="$CI_PIP_INDEX_URL" ${CI_PIP_TRUSTED_HOST:+--trusted-host="$CI_PIP_TRUSTED_HOST"}
      else
        python -m pip install --upgrade pip
      fi

# Cache pip packages to speed up subsequent runs
.cache_template: &cache_template
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .cache/pip

# Template for pip install with mirror support
.pip_install: &pip_install
  - |
    if [ -n "$CI_PIP_INDEX_URL" ]; then
      pip install -r requirements.txt -r requirements-dev.txt \
        --index-url="$CI_PIP_INDEX_URL" \
        ${CI_PIP_TRUSTED_HOST:+--trusted-host="$CI_PIP_TRUSTED_HOST"}
    else
      pip install -r requirements.txt -r requirements-dev.txt
    fi

# ============================================================================
# TEST STAGE
# ============================================================================

# Run tests on Python 3.11
test:python-3.11:
  stage: test
  image: ${CI_DOCKER_REGISTRY}python:3.11-alpine
  <<: *cache_template
  script:
    - *pip_install
    - python -m pytest -q
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'

# Run tests on Python 3.12
test:python-3.12:
  stage: test
  image: ${CI_DOCKER_REGISTRY}python:3.12-alpine
  <<: *cache_template
  script:
    - *pip_install
    - python -m pytest -q
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'

# Manual E2E tests against live GitLab instances
# Equivalent to GitHub's workflow_dispatch in e2e-live-gitlab.yml
test:e2e-live:
  stage: test
  image: ${CI_DOCKER_REGISTRY}python:3.12-alpine
  <<: *cache_template
  script:
    - *pip_install
    - |
      # Set test scope based on E2E_TEST_SCOPE variable (default: single)
      TEST_SCOPE="${E2E_TEST_SCOPE:-single}"
      case "$TEST_SCOPE" in
        single)
          MARKERS="-m 'live_gitlab and not dual_instance'"
          ;;
        dual)
          MARKERS="-m dual_instance"
          ;;
        multi-project)
          MARKERS="-m multi_project"
          ;;
        multi-group)
          MARKERS="-m multi_group"
          ;;
        all)
          MARKERS="-m live_gitlab"
          ;;
        *)
          MARKERS="-m 'live_gitlab and not dual_instance'"
          ;;
      esac
      echo "Running E2E tests with scope: $TEST_SCOPE (markers: $MARKERS)"
      python -m pytest -v $MARKERS
  variables:
    # Hard opt-in guardrail
    E2E_LIVE_GITLAB: "1"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
  # Configure these variables in GitLab CI/CD settings:
  # - E2E_GITLAB_URL: GitLab instance 1 URL
  # - E2E_GITLAB_GROUP_PATH: GitLab instance 1 group path
  # - E2E_GITLAB_TOKEN: GitLab instance 1 access token (masked)
  # - E2E_GITLAB_URL_2: GitLab instance 2 URL (for dual-instance tests)
  # - E2E_GITLAB_GROUP_PATH_2: GitLab instance 2 group path
  # - E2E_GITLAB_TOKEN_2: GitLab instance 2 access token (masked)
  # - E2E_GITLAB_HTTP_USERNAME: HTTP username for PAT auth (default: oauth2)
  # - E2E_GITLAB_MIRROR_TIMEOUT_S: Seconds to wait for mirror sync (default: 120)
  # - E2E_TEST_SCOPE: Test scope (single, dual, multi-project, multi-group, all)

# ============================================================================
# BUILD STAGE
# ============================================================================

# Build multi-architecture Docker images and push to GitLab Container Registry
# Only runs on version tags (v1.2.3)
build:docker:
  stage: build
  image: ${CI_DOCKER_REGISTRY}docker:24
  services:
    - name: ${CI_DOCKER_REGISTRY}docker:24-dind
      alias: docker
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
    # Use GitLab Container Registry
    IMAGE_NAME: $CI_REGISTRY_IMAGE
  before_script:
    # Install buildx for multi-arch builds
    - apk add --no-cache git
    - docker context create builder
    - docker buildx create --use builder
    - docker buildx inspect --bootstrap
    # Login to GitLab Container Registry
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    # Extract version from tag (v1.2.3 -> 1.2.3)
    - export VERSION=${CI_COMMIT_TAG#v}
    - export MAJOR=$(echo $VERSION | cut -d. -f1)
    - export MINOR=$(echo $VERSION | cut -d. -f1,2)

    # Prepare build args for local mirrors (if configured)
    - |
      BUILD_ARGS=""
      if [ -n "$DOCKER_REGISTRY" ]; then
        BUILD_ARGS="$BUILD_ARGS --build-arg DOCKER_REGISTRY=$DOCKER_REGISTRY"
      fi
      if [ -n "$APT_MIRROR" ]; then
        BUILD_ARGS="$BUILD_ARGS --build-arg APT_MIRROR=$APT_MIRROR"
      fi
      if [ -n "$PIP_INDEX_URL" ]; then
        BUILD_ARGS="$BUILD_ARGS --build-arg PIP_INDEX_URL=$PIP_INDEX_URL"
      fi
      if [ -n "$PIP_TRUSTED_HOST" ]; then
        BUILD_ARGS="$BUILD_ARGS --build-arg PIP_TRUSTED_HOST=$PIP_TRUSTED_HOST"
      fi

      echo "Build args: $BUILD_ARGS"

    # Build and push multi-architecture image
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --push \
        --tag "$IMAGE_NAME:$VERSION" \
        --tag "$IMAGE_NAME:$MINOR" \
        --tag "$IMAGE_NAME:$MAJOR" \
        --tag "$IMAGE_NAME:latest" \
        --cache-from type=registry,ref=$IMAGE_NAME:buildcache \
        --cache-to type=registry,ref=$IMAGE_NAME:buildcache,mode=max \
        $BUILD_ARGS \
        .

    - echo "Successfully built and pushed image:"
    - echo "  - $IMAGE_NAME:$VERSION"
    - echo "  - $IMAGE_NAME:$MINOR"
    - echo "  - $IMAGE_NAME:$MAJOR"
    - echo "  - $IMAGE_NAME:latest"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  needs:
    - test:python-3.11
    - test:python-3.12

# ============================================================================
# RELEASE STAGE
# ============================================================================

# Create GitLab release with auto-generated changelog
# Only runs on version tags (v1.2.3)
release:gitlab:
  stage: release
  # Note: release-cli is from registry.gitlab.com, may need to be mirrored
  # If using local registry, mirror registry.gitlab.com/gitlab-org/release-cli:latest
  # and set CI_RELEASE_CLI_IMAGE variable to your local mirror path
  image: ${CI_RELEASE_CLI_IMAGE:-registry.gitlab.com/gitlab-org/release-cli:latest}
  before_script:
    - apk add --no-cache git
  script:
    # Generate changelog from commits since last tag
    - |
      PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CI_COMMIT_TAG^ 2>/dev/null || echo "")
      if [ -z "$PREVIOUS_TAG" ]; then
        # First release - get all commits
        CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
      else
        # Get commits since previous tag
        CHANGELOG=$(git log ${PREVIOUS_TAG}..$CI_COMMIT_TAG --pretty=format:"- %s (%h)" --no-merges)
      fi

      # Save changelog to file
      echo "$CHANGELOG" > CHANGELOG.txt

      # Create release description
      cat > RELEASE_DESCRIPTION.md <<EOF
      ## Docker Image

      Pull the image from GitLab Container Registry:

      \`\`\`bash
      docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
      \`\`\`

      Or use the latest tag:

      \`\`\`bash
      docker pull $CI_REGISTRY_IMAGE:latest
      \`\`\`

      ## Quick Start

      \`\`\`bash
      # Create required directories and files
      mkdir -p data ssl
      cp .env.example .env

      # Update docker-compose.yml to use the published image
      # (replace 'build: .' with 'image: $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG')

      # Start the application
      docker-compose up -d
      \`\`\`

      See the [README]($CI_PROJECT_URL/-/blob/main/README.md) for full documentation.

      ## What's Changed

      $CHANGELOG
      EOF

      cat RELEASE_DESCRIPTION.md
  release:
    tag_name: '$CI_COMMIT_TAG'
    name: 'Release $CI_COMMIT_TAG'
    description: './RELEASE_DESCRIPTION.md'
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  needs:
    - build:docker

# ============================================================================
# DOCUMENTATION
# ============================================================================

# How to use this pipeline:
#
# 1. AUTOMATIC TESTS (on every push/MR):
#    - Push code to any branch
#    - Tests run automatically on Python 3.11 and 3.12
#
# 2. MANUAL E2E TESTS:
#    - Go to CI/CD > Pipelines > Run Pipeline
#    - Click "Run pipeline" button
#    - Configure variables (optional):
#      - E2E_TEST_SCOPE: single, dual, multi-project, multi-group, or all
#    - The E2E test job will appear as "manual" - click the play button
#    - Requires pre-configured CI/CD variables (see test:e2e-live job)
#
# 3. RELEASE (on version tags):
#    - Update version in pyproject.toml
#    - Commit: git commit -m "chore: bump version to 1.2.3"
#    - Create tag: git tag v1.2.3
#    - Push: git push origin main --tags
#    - Pipeline will:
#      a. Run tests on Python 3.11 and 3.12
#      b. Build multi-arch Docker images (amd64, arm64)
#      c. Push to GitLab Container Registry with tags:
#         - v1.2.3 (exact version)
#         - 1.2 (minor version)
#         - 1 (major version)
#         - latest
#      d. Create GitLab release with auto-generated changelog
#
# 4. REQUIRED CI/CD VARIABLES (for E2E tests):
#    Settings > CI/CD > Variables:
#    - E2E_GITLAB_URL (protected, not masked)
#    - E2E_GITLAB_GROUP_PATH (protected, not masked)
#    - E2E_GITLAB_TOKEN (protected, masked)
#    - E2E_GITLAB_URL_2 (optional, for dual-instance tests)
#    - E2E_GITLAB_GROUP_PATH_2 (optional, for dual-instance tests)
#    - E2E_GITLAB_TOKEN_2 (optional, for dual-instance tests)
#
# 5. COEXISTENCE WITH GITHUB ACTIONS:
#    - GitHub ignores .gitlab-ci.yml
#    - GitLab ignores .github/workflows/
#    - Both can run independently
#    - Use GitHub Container Registry (ghcr.io) for GitHub releases
#    - Use GitLab Container Registry ($CI_REGISTRY) for GitLab releases
