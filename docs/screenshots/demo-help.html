<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirror Maestro - Help</title>
    <link rel="stylesheet" href="../../app/static/css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-title-section">
                    <img src="../../app/static/images/logo.svg" alt="Mirror Maestro Logo" class="header-logo">
                    <div>
                        <h1>Mirror Maestro</h1>
                        <p>Orchestrate GitLab mirrors across multiple instance pairs with precision</p>
                    </div>
                </div>
                <div class="header-controls">
                    <div class="global-search-container">
                        <input type="search" id="global-search" class="global-search-input" placeholder="Search instances, pairs, mirrors..." aria-label="Global search">
                        <div id="global-search-results" class="global-search-results"></div>
                    </div>
                    <button id="dark-mode-toggle" class="dark-mode-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">
                        <span class="theme-icon theme-icon-light">‚òÄÔ∏è</span>
                        <span class="theme-icon theme-icon-dark">üåô</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab" data-tab="dashboard-tab">Dashboard</button>
            <button class="tab" data-tab="instances-tab">GitLab Instances</button>
            <button class="tab" data-tab="pairs-tab">Instance Pairs</button>
            <button class="tab" data-tab="mirrors-tab">Mirrors</button>
            <button class="tab" data-tab="topology-tab">Topology</button>
            <button class="tab" data-tab="backup-tab">Backup</button>
            <button class="tab" data-tab="settings-tab">Settings</button>
            <button class="tab" data-tab="about-tab">About</button>
            <button class="tab active" data-tab="help-tab">Help</button>
        </div>

        <!-- Help Tab -->
        <div id="help-tab" class="tab-content active">
            <!-- Getting Started -->
            <div class="card">
                <h2>Getting Started</h2>
                <p class="text-muted">Welcome to Mirror Maestro - your tool for orchestrating GitLab mirrors across multiple instances.</p>

                <h3>What is Mirror Maestro?</h3>
                <p>Mirror Maestro simplifies the management of GitLab repository mirrors. Whether you need to sync repositories between GitLab instances, create backups, or maintain read-only copies, Mirror Maestro provides a centralized interface to configure and monitor all your mirrors.</p>

                <h3>Core Concepts</h3>
                <ul>
                    <li><strong>GitLab Instances</strong> - Your GitLab servers (self-hosted or GitLab.com). Each instance needs an access token with API permissions.</li>
                    <li><strong>Instance Pairs</strong> - A connection between two instances (or the same instance) that defines the mirroring direction and default settings.</li>
                    <li><strong>Mirrors</strong> - Individual repository mirrors that sync content from a source project to a target project.</li>
                </ul>

                <h3>Quick Start: Create Your First Mirror</h3>
                <ol>
                    <li><strong>Add a GitLab Instance</strong> - Go to GitLab Instances and add your GitLab server with an access token.</li>
                    <li><strong>Create an Instance Pair</strong> - Go to Instance Pairs and create a pair (can be the same instance for internal mirroring).</li>
                    <li><strong>Create a Mirror</strong> - Go to Mirrors, select your pair, choose source and target projects, and create the mirror. Authentication tokens are managed automatically.</li>
                </ol>
            </div>

            <!-- GitLab Instances -->
            <div class="card">
                <h2>GitLab Instances</h2>
                <p class="text-muted">Configure connections to your GitLab servers.</p>

                <h3>Required Token Permissions</h3>
                <p>The instance access token needs the following scopes:</p>
                <ul>
                    <li><strong>api</strong> - Full API access (required for creating and managing mirrors)</li>
                    <li><strong>read_repository</strong> - Read access to repositories (for pull mirrors)</li>
                    <li><strong>write_repository</strong> - Write access to repositories (for push mirrors)</li>
                </ul>
                <p>You can use a Personal Access Token (PAT) or a Project/Group Access Token with these scopes.</p>

                <h3>Adding an Instance</h3>
                <ol>
                    <li>Navigate to the GitLab Instances tab</li>
                    <li>Fill in the instance name (e.g., "Production GitLab")</li>
                    <li>Enter the instance URL (e.g., <code>https://gitlab.example.com</code>)</li>
                    <li>Paste your access token</li>
                    <li>Click "Add Instance" - the connection will be tested automatically</li>
                </ol>

                <h3>Testing Connections</h3>
                <p>After adding an instance, Mirror Maestro verifies the token by fetching the authenticated user's information. If successful, you'll see the API username displayed in the instances table.</p>
            </div>

            <!-- Instance Pairs -->
            <div class="card">
                <h2>Instance Pairs</h2>
                <p class="text-muted">Define mirroring relationships between GitLab instances.</p>

                <h3>Push vs Pull Mirroring</h3>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Direction</th>
                            <th>Use Case</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Push</strong></td>
                            <td>Source ‚Üí Target</td>
                            <td>The source repository pushes changes to the target. Best for active development repos pushing to backups or read-only copies.</td>
                        </tr>
                        <tr>
                            <td><strong>Pull</strong></td>
                            <td>Target ‚Üê Source</td>
                            <td>The target repository pulls changes from the source. Best when you want the target to control when it syncs.</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Creating a Pair</h3>
                <ol>
                    <li>Navigate to the Instance Pairs tab</li>
                    <li>Enter a descriptive name (e.g., "Dev to Prod Sync")</li>
                    <li>Select the source and target instances</li>
                    <li>Choose the mirror direction (push or pull)</li>
                    <li>Configure default settings for mirrors in this pair</li>
                    <li>Click "Create Pair"</li>
                </ol>

                <h3>Pair-Level Default Settings</h3>
                <p>Settings configured on a pair become defaults for all mirrors in that pair. Individual mirrors can override these settings.</p>
                <ul>
                    <li><strong>Mirror protected branches only</strong> - Only sync branches that are protected</li>
                    <li><strong>Trigger builds</strong> - Run CI/CD pipelines on the target after sync</li>
                    <li><strong>Overwrite diverged branches</strong> - Force-update branches that have diverged</li>
                </ul>
            </div>

            <!-- Mirror Management -->
            <div class="card">
                <h2>Mirror Management</h2>
                <p class="text-muted">Create, view, and manage mirrors with powerful navigation and filtering tools.</p>

                <h3>Viewing Mirrors</h3>
                <p>Mirror Maestro provides flexible ways to view and navigate your mirrors, especially useful when managing large numbers of mirrors in nested group structures:</p>

                <h4>Flat View (Default)</h4>
                <ul>
                    <li><strong>Smart Path Truncation</strong> - Long nested paths automatically show only the last few segments (e.g., <code>... / services / api-gateway</code>)</li>
                    <li><strong>Full Path Tooltips</strong> - Hover over any path to see the complete path</li>
                    <li><strong>Pagination</strong> - Navigate through pages of mirrors with configurable page size (25/50/100/200 per page)</li>
                </ul>

                <h4>Tree View</h4>
                <ul>
                    <li>Click the "Tree View" button to switch to hierarchical display</li>
                    <li>Mirrors are grouped by their path structure (groups and subgroups)</li>
                    <li>Expand/collapse group nodes to navigate the hierarchy</li>
                    <li>Group headers show mirror count for that branch</li>
                    <li>Perfect for organizing mirrors in deeply nested group structures</li>
                </ul>

                <h3>Filtering Mirrors</h3>
                <p>Use the filter controls above the mirror table:</p>
                <ul>
                    <li><strong>Group Path Filter</strong> - Enter a group path prefix (e.g., <code>platform/core</code>) to show only mirrors within that group tree</li>
                    <li><strong>Sort By</strong> - Sort mirrors by created date, updated date, source path, target path, or status</li>
                    <li><strong>Order</strong> - Choose ascending or descending sort order</li>
                </ul>

                <h3>Creating Mirrors</h3>
                <ol>
                    <li>Select an instance pair from the dropdown</li>
                    <li>Search for source and target projects (type at least 2 characters)</li>
                    <li>Optionally configure per-mirror settings (or inherit from pair defaults)</li>
                    <li>Click "Create Mirror"</li>
                </ol>
                <p><strong>Note:</strong> Project access tokens are automatically created and managed by Mirror Maestro - no manual token configuration needed!</p>

                <h3>Mirror Actions</h3>
                <ul>
                    <li><strong>Edit</strong> - Modify mirror settings inline (project paths cannot be changed after creation)</li>
                    <li><strong>Sync</strong> - Force an immediate mirror synchronization</li>
                    <li><strong>Rotate Token</strong> - Create a new project access token and revoke the old one</li>
                    <li><strong>Delete</strong> - Remove the mirror configuration (and associated tokens)</li>
                </ul>

                <h3>Pagination Controls</h3>
                <p>At the bottom of the mirror table:</p>
                <ul>
                    <li><strong>Page Navigation</strong> - Jump to specific pages or use Previous/Next buttons</li>
                    <li><strong>Page Size</strong> - Select how many mirrors to show per page (25/50/100/200)</li>
                    <li><strong>Current Range</strong> - See which mirrors you're viewing (e.g., "Showing 1-50 of 237 mirrors")</li>
                </ul>

                <h3>Best Practices</h3>
                <ul>
                    <li>Use group path filters to focus on specific parts of your GitLab hierarchy</li>
                    <li>Switch to tree view when working with deeply nested groups</li>
                    <li>Sort by source path to group similar projects together</li>
                    <li>Use larger page sizes (100-200) when doing bulk operations</li>
                    <li>Monitor token status and rotate tokens before they expire</li>
                </ul>
            </div>

            <!-- Mirror Verification -->
            <div class="card">
                <h2>Mirror Verification</h2>
                <p class="text-muted">Detect orphaned mirrors and configuration drift between your database and GitLab.</p>

                <h3>Understanding Mirror Health</h3>
                <p>Mirror Maestro can verify that mirrors configured in its database actually exist on GitLab and have matching settings. This helps detect:</p>

                <h4>Orphaned Mirrors</h4>
                <p>A mirror is <strong>orphaned</strong> when it exists in Mirror Maestro's database but the corresponding mirror no longer exists on GitLab (e.g., someone deleted it directly in GitLab).</p>
                <ul>
                    <li><span class="badge badge-danger">Orphan</span> - Mirror record exists but GitLab mirror was deleted</li>
                    <li><strong>Resolution:</strong> Delete the orphaned record from Mirror Maestro, or recreate the mirror on GitLab</li>
                </ul>

                <h4>Configuration Drift</h4>
                <p>A mirror has <strong>drift</strong> when its settings in Mirror Maestro's database don't match the actual settings on GitLab.</p>
                <ul>
                    <li><span class="badge badge-warning">Drift</span> - Settings mismatch detected</li>
                    <li>Checked settings: enabled status, protected branches only, keep divergent refs, trigger builds, branch regex</li>
                    <li><strong>Resolution:</strong> Edit the mirror to resync settings, or accept the GitLab-side changes</li>
                </ul>

                <h3>Health Status Badges</h3>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Badge</th>
                            <th>Meaning</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge badge-success">‚úì</span></td>
                            <td>Mirror is healthy - exists on GitLab with matching settings</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-warning">Drift</span></td>
                            <td>Settings mismatch between database and GitLab</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-danger">Orphan</span></td>
                            <td>Mirror no longer exists on GitLab</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-secondary">‚Äî</span></td>
                            <td>Mirror not yet created on GitLab (no mirror_id)</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Verification Actions</h3>
                <ul>
                    <li><strong>Verify (per-row)</strong> - Check a single mirror's health status</li>
                    <li><strong>Verify All</strong> - Check all visible mirrors in batch</li>
                </ul>
                <p>Results are cached during the session to avoid repeated API calls.</p>

                <h3>External Mirror Indicator</h3>
                <p>When selecting projects for a new mirror, Mirror Maestro checks if the selected project already has existing mirrors configured directly on GitLab:</p>
                <ul>
                    <li><span class="badge badge-warning">‚ö† 1 push</span> - Shows count and type of existing mirrors</li>
                    <li>This helps avoid conflicts when creating new mirrors</li>
                    <li>Existing mirrors may prevent new mirror creation (use preflight check)</li>
                </ul>
            </div>

            <!-- System Health -->
            <div class="card">
                <h2>System Health</h2>
                <p class="text-muted">Monitor the health of your Mirror Maestro installation.</p>

                <h3>Health Status Levels</h3>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Meaning</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge badge-success">Healthy</span></td>
                            <td>All systems operational. Database connected, mirrors syncing, tokens valid.</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-warning">Degraded</span></td>
                            <td>Some issues detected. May have failed mirrors, expiring tokens, or unreachable instances.</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-danger">Unhealthy</span></td>
                            <td>Critical issues. Database may be down, most mirrors failing, or other severe problems.</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Health API Endpoints</h3>
                <p>For monitoring tools and load balancers:</p>
                <ul>
                    <li><code>GET /api/health/quick</code> - Fast health check (no auth required)</li>
                    <li><code>GET /api/health</code> - Detailed health with component status</li>
                </ul>
            </div>

            <!-- Issue Mirroring -->
            <div class="card">
                <h2>Issue Mirroring</h2>
                <p class="text-muted">Automatically sync issues, comments, labels, and attachments between mirrored repositories.</p>

                <h3>What is Issue Mirroring?</h3>
                <p>In addition to syncing repository code, Mirror Maestro can synchronize GitLab issues between source and target projects. This keeps issue trackers in sync across instances, making it perfect for:</p>
                <ul>
                    <li>Maintaining consistent issue tracking across dev/staging/prod environments</li>
                    <li>Creating backup copies of issue data alongside code mirrors</li>
                    <li>Consolidating issues from multiple instances into a central tracking system</li>
                </ul>

                <h3>Configuring Issue Syncing</h3>
                <ol>
                    <li>Navigate to the Mirrors tab and click the "Issue Configs" button</li>
                    <li>Click "Create Issue Config" and select a mirror</li>
                    <li>Configure what to sync:
                        <ul>
                            <li><strong>Sync Comments</strong> - Mirror all issue comments and notes</li>
                            <li><strong>Sync Labels</strong> - Copy labels to target issues</li>
                            <li><strong>Sync Attachments</strong> - Download and upload issue attachments</li>
                            <li><strong>Sync Weight/Time Tracking</strong> - Copy issue weight, time estimates, and time spent</li>
                            <li><strong>Sync Closed Issues</strong> - Include closed/resolved issues in sync</li>
                        </ul>
                    </li>
                    <li>Set the sync interval (5-1440 minutes, default: 15 minutes)</li>
                    <li>Click "Create Config" to enable automatic syncing</li>
                </ol>

                <h3>Production-Ready Robustness</h3>
                <p>Mirror Maestro's issue syncing is built for reliability in production environments with the following features:</p>

                <h4>Circuit Breaker Protection</h4>
                <p>Prevents cascading failures when GitLab instances experience issues:</p>
                <ul>
                    <li>After 5 consecutive failures (configurable), the sync pauses automatically</li>
                    <li>Waits 60 seconds (configurable) before attempting recovery</li>
                    <li>Protects both your Mirror Maestro server and GitLab instances from overload</li>
                </ul>

                <h4>Automatic Retry with Backoff</h4>
                <p>Transient network errors don't stop your syncs:</p>
                <ul>
                    <li>Automatically retries failed operations up to 3 times</li>
                    <li>Uses exponential backoff (1s, 2s, 4s delays) to avoid overwhelming the API</li>
                    <li>Distinguishes between retryable errors (network) and permanent failures (permissions)</li>
                </ul>

                <h4>Progress Checkpointing</h4>
                <p>Large syncs can be interrupted and resumed without data loss:</p>
                <ul>
                    <li>Processes issues in batches of 50 (configurable)</li>
                    <li>Commits progress after each batch to the database</li>
                    <li>If interrupted, next sync resumes from where it left off</li>
                    <li>Perfect for syncing thousands of issues safely</li>
                </ul>

                <h4>Memory Management</h4>
                <p>Efficiently handles large repositories without exhausting resources:</p>
                <ul>
                    <li>Batched processing prevents loading all issues into memory at once</li>
                    <li>Streaming downloads for attachments</li>
                    <li>Pagination limits prevent API response overload (max 100 pages)</li>
                    <li>Maximum 10,000 issues per sync (configurable)</li>
                </ul>

                <h4>Attachment Safety</h4>
                <p>Protects against oversized file transfers:</p>
                <ul>
                    <li>Default 100MB limit per attachment (configurable)</li>
                    <li>Checks file size before downloading (via Content-Length header)</li>
                    <li>Validates actual content size after download</li>
                    <li>Set to 0 for unlimited size (use with caution)</li>
                </ul>

                <h4>Rate Limiting</h4>
                <p>Stays within GitLab's API quotas:</p>
                <ul>
                    <li>Automatic 200ms delay between operations (~300 ops/min)</li>
                    <li>Well under GitLab's 600 requests/min limit</li>
                    <li>Prevents API quota exhaustion even with large syncs</li>
                </ul>

                <h4>Graceful Shutdown</h4>
                <p>Safe deployment and maintenance:</p>
                <ul>
                    <li>Active sync jobs complete before shutdown</li>
                    <li>Configurable timeout (default: 300 seconds)</li>
                    <li>No data loss during restarts or deployments</li>
                    <li>Partially completed syncs resume on next run</li>
                </ul>

                <h3>Configuration Options</h3>
                <p>Advanced settings can be configured via environment variables:</p>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Setting</th>
                            <th>Default</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>CIRCUIT_BREAKER_FAILURE_THRESHOLD</code></td>
                            <td>5</td>
                            <td>Failures before circuit opens</td>
                        </tr>
                        <tr>
                            <td><code>CIRCUIT_BREAKER_RECOVERY_TIMEOUT</code></td>
                            <td>60</td>
                            <td>Seconds to wait before recovery attempt</td>
                        </tr>
                        <tr>
                            <td><code>MAX_ISSUES_PER_SYNC</code></td>
                            <td>10000</td>
                            <td>Maximum issues to process in one sync</td>
                        </tr>
                        <tr>
                            <td><code>MAX_PAGES_PER_REQUEST</code></td>
                            <td>100</td>
                            <td>Maximum API pagination pages</td>
                        </tr>
                        <tr>
                            <td><code>MAX_ATTACHMENT_SIZE_MB</code></td>
                            <td>100</td>
                            <td>Maximum attachment size in MB (0=unlimited)</td>
                        </tr>
                        <tr>
                            <td><code>ATTACHMENT_DOWNLOAD_TIMEOUT</code></td>
                            <td>30</td>
                            <td>Timeout for downloading attachments (seconds)</td>
                        </tr>
                        <tr>
                            <td><code>ISSUE_BATCH_SIZE</code></td>
                            <td>50</td>
                            <td>Issues per checkpoint batch</td>
                        </tr>
                        <tr>
                            <td><code>SYNC_SHUTDOWN_TIMEOUT</code></td>
                            <td>300</td>
                            <td>Max wait for syncs during shutdown (seconds)</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Monitoring Sync Status</h3>
                <p>Track your issue syncs in the Issue Configs view:</p>
                <ul>
                    <li><strong>Last Sync</strong> - Timestamp of most recent sync</li>
                    <li><strong>Status</strong> - Success, failed, or in progress</li>
                    <li><strong>Next Sync</strong> - When the next automatic sync will run</li>
                    <li><strong>Error Message</strong> - Details if sync failed</li>
                    <li><strong>Manual Trigger</strong> - Force immediate sync with "Trigger Sync" button</li>
                </ul>

                <h3>Best Practices</h3>
                <ul>
                    <li>Start with a short sync interval (15 min) for active projects</li>
                    <li>For initial syncs of large repos, consider disabling sync_existing_issues temporarily</li>
                    <li>Monitor attachment sizes - large files can slow syncs significantly</li>
                    <li>Use longer intervals (60+ min) for archived or infrequently updated projects</li>
                    <li>Check sync status regularly to catch configuration issues early</li>
                    <li>Increase batch size for repositories with thousands of issues to reduce overhead</li>
                </ul>
            </div>

            <!-- Troubleshooting -->
            <div class="card">
                <h2>Troubleshooting</h2>
                <p class="text-muted">Common issues and how to resolve them.</p>

                <h3>Connection Errors</h3>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Error</th>
                            <th>Cause</th>
                            <th>Solution</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>401 Unauthorized</code></td>
                            <td>Invalid or expired token</td>
                            <td>Regenerate the access token and update the instance configuration</td>
                        </tr>
                        <tr>
                            <td><code>403 Forbidden</code></td>
                            <td>Token lacks required scopes</td>
                            <td>Ensure the token has <code>api</code>, <code>read_repository</code>, and <code>write_repository</code> scopes</td>
                        </tr>
                        <tr>
                            <td><code>Connection refused</code></td>
                            <td>Network/firewall issue</td>
                            <td>Check that the GitLab instance is reachable from the Mirror Maestro server</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Getting Help</h3>
                <p>If you encounter issues not covered here:</p>
                <ul>
                    <li>Check the GitLab project's mirror settings directly in the GitLab UI</li>
                    <li>Review GitLab's documentation on <a href="https://docs.gitlab.com/ee/user/project/repository/mirror/" target="_blank" rel="noopener">repository mirroring</a></li>
                    <li>Open an issue on the <a href="https://github.com/MrZoller/mirror-maestro/issues" target="_blank" rel="noopener">Mirror Maestro GitHub repository</a></li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
