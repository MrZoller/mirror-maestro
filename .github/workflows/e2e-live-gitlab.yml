name: Live GitLab E2E (manual)

on:
  workflow_dispatch:
    inputs:
      test_scope:
        description: "Test scope"
        required: false
        default: "single"
        type: choice
        options:
          - single
          - dual
          - multi-project
          - multi-group
          - all
      gitlab_url:
        description: "GitLab 1 base URL (optional override)"
        required: false
        type: string
      gitlab_group_path:
        description: "GitLab 1 group full_path (optional override)"
        required: false
        type: string
      gitlab_url_2:
        description: "GitLab 2 base URL (for dual-instance tests)"
        required: false
        type: string
      gitlab_group_path_2:
        description: "GitLab 2 group full_path (for dual-instance tests)"
        required: false
        type: string
      http_username:
        description: "HTTP username for PAT auth (default: oauth2)"
        required: false
        default: "oauth2"
        type: string
      mirror_timeout_s:
        description: "Seconds to wait for mirror sync (default: 120)"
        required: false
        default: "120"
        type: string

permissions:
  contents: read

concurrency:
  group: live-gitlab-e2e
  cancel-in-progress: false

jobs:
  e2e:
    name: Run live GitLab E2E
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt -r requirements-dev.txt

      - name: Run E2E tests
        env:
          # Hard opt-in guardrail
          E2E_LIVE_GITLAB: "1"

          # Instance 1: prefer workflow inputs, fall back to secrets
          E2E_GITLAB_URL: ${{ inputs.gitlab_url || secrets.E2E_GITLAB_URL }}
          E2E_GITLAB_GROUP_PATH: ${{ inputs.gitlab_group_path || secrets.E2E_GITLAB_GROUP_PATH }}
          E2E_GITLAB_TOKEN: ${{ secrets.E2E_GITLAB_TOKEN }}

          # Instance 2 (for dual-instance tests)
          E2E_GITLAB_URL_2: ${{ inputs.gitlab_url_2 || secrets.E2E_GITLAB_URL_2 }}
          E2E_GITLAB_GROUP_PATH_2: ${{ inputs.gitlab_group_path_2 || secrets.E2E_GITLAB_GROUP_PATH_2 }}
          E2E_GITLAB_TOKEN_2: ${{ secrets.E2E_GITLAB_TOKEN_2 }}

          # Optional tuning
          E2E_GITLAB_HTTP_USERNAME: ${{ inputs.http_username }}
          E2E_GITLAB_MIRROR_TIMEOUT_S: ${{ inputs.mirror_timeout_s }}
        run: |
          MARKERS=""
          case "${{ inputs.test_scope }}" in
            single)
              MARKERS="-m 'live_gitlab and not dual_instance'"
              ;;
            dual)
              MARKERS="-m dual_instance"
              ;;
            multi-project)
              MARKERS="-m multi_project"
              ;;
            multi-group)
              MARKERS="-m multi_group"
              ;;
            all)
              MARKERS="-m live_gitlab"
              ;;
            *)
              MARKERS="-m 'live_gitlab and not dual_instance'"
              ;;
          esac
          echo "Running tests with markers: $MARKERS"
          python -m pytest -v $MARKERS
