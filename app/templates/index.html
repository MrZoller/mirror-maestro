<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="icon" type="image/png" sizes="128x128" href="/favicon-128x128.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64x64.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/static/css/style.css">
    {% if use_local_vendor_assets %}
    <script src="/static/vendor/chart.umd.min.js"></script>
    {% else %}
    <script src="{{ cdn_chartjs_url }}"></script>
    {% endif %}
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-title-section">
                    <img src="/static/images/logo.svg" alt="Mirror Maestro Logo" class="header-logo">
                    <div>
                        <h1>{{ title }}</h1>
                        <p>Orchestrate GitLab mirrors across multiple instance pairs with precision</p>
                    </div>
                </div>
                <div class="header-controls">
                    <div class="global-search-container">
                        <input type="search" id="global-search" class="global-search-input" placeholder="Search instances, pairs, mirrors..." aria-label="Global search">
                        <div id="global-search-results" class="global-search-results"></div>
                    </div>
                    <button id="dark-mode-toggle" class="dark-mode-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">
                        <span class="theme-icon theme-icon-light">‚òÄÔ∏è</span>
                        <span class="theme-icon theme-icon-dark">üåô</span>
                    </button>
                    <div class="user-menu" id="user-menu" style="display: none;">
                        <button class="user-menu-toggle" id="user-menu-toggle" aria-label="User menu">
                            <span class="user-avatar">üë§</span>
                            <span class="user-name" id="user-name">User</span>
                            <span class="user-menu-arrow">‚ñº</span>
                        </button>
                        <div class="user-menu-dropdown" id="user-menu-dropdown">
                            <div class="user-menu-info">
                                <div class="user-menu-username" id="user-menu-username">-</div>
                                <div class="user-menu-role" id="user-menu-role">-</div>
                            </div>
                            <hr class="user-menu-divider">
                            <button class="user-menu-item" onclick="showChangePasswordModal()">
                                Change Password
                            </button>
                            <button class="user-menu-item user-menu-logout" onclick="logout()">
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="message-container"></div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="dashboard-tab">Dashboard</button>
            <button class="tab" data-tab="instances-tab">GitLab Instances</button>
            <button class="tab" data-tab="pairs-tab">Instance Pairs</button>
            <button class="tab" data-tab="mirrors-tab">Mirrors</button>
            <button class="tab" data-tab="topology-tab">Topology</button>
            <button class="tab" data-tab="backup-tab">Backup</button>
            <button class="tab" data-tab="settings-tab" id="settings-tab-btn" style="display: none;">Settings</button>
            <button class="tab" data-tab="about-tab">About</button>
            <button class="tab" data-tab="help-tab">Help</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <!-- Stats Cards -->
            <div class="dashboard-stats">
                <div class="stat-card stat-card-primary">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-total-mirrors">-</div>
                        <div class="stat-label">Total Mirrors</div>
                    </div>
                </div>
                <div class="stat-card stat-card-success">
                    <div class="stat-icon">‚úì</div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-health-percentage">-</div>
                        <div class="stat-label">Health</div>
                    </div>
                </div>
                <div class="stat-card stat-card-danger">
                    <div class="stat-icon">‚ö†</div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-failed-mirrors">-</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
                <div class="stat-card stat-card-info">
                    <div class="stat-icon">‚Üª</div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-syncing-mirrors">-</div>
                        <div class="stat-label">Syncing Now</div>
                    </div>
                </div>
            </div>

            <!-- Main Dashboard Content -->
            <div class="dashboard-grid">
                <!-- Recent Activity -->
                <div class="card dashboard-activity">
                    <div class="flex-between">
                        <h3>Recent Activity</h3>
                        <span class="text-muted" id="activity-timestamp">Just now</span>
                    </div>
                    <div id="recent-activity-list" class="activity-list mt-20">
                        <div class="skeleton">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text"></div>
                        </div>
                    </div>
                </div>

                <!-- Health Distribution -->
                <div class="card dashboard-health">
                    <h3>Mirror Health</h3>
                    <div class="health-chart mt-20">
                        <canvas id="health-chart"></canvas>
                    </div>
                    <div class="health-legend mt-20">
                        <div class="health-legend-item">
                            <span class="health-dot health-dot-success"></span>
                            <span id="health-success-count">0</span> Success
                        </div>
                        <div class="health-legend-item">
                            <span class="health-dot health-dot-failed"></span>
                            <span id="health-failed-count">0</span> Failed
                        </div>
                        <div class="health-legend-item">
                            <span class="health-dot health-dot-pending"></span>
                            <span id="health-pending-count">0</span> Pending
                        </div>
                        <div class="health-legend-item">
                            <span class="health-dot health-dot-unknown"></span>
                            <span id="health-unknown-count">0</span> Unknown
                        </div>
                    </div>
                </div>

                <!-- Top Pairs -->
                <div class="card dashboard-pairs">
                    <h3>Mirrors by Pair</h3>
                    <div id="pairs-distribution" class="pairs-list mt-20">
                        <div class="skeleton">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text"></div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card dashboard-actions">
                    <h3>Quick Actions</h3>
                    <div class="quick-actions mt-20">
                        <button class="btn btn-primary" onclick="switchTab('mirrors-tab')">
                            Create Mirror
                        </button>
                        <button class="btn btn-secondary" onclick="switchTab('instances-tab')">
                            Add Instance
                        </button>
                        <button class="btn btn-secondary" onclick="switchTab('pairs-tab')">
                            Create Pair
                        </button>
                        <button class="btn btn-secondary" onclick="switchTab('topology-tab')">
                            View Topology
                        </button>
                    </div>
                </div>

                <!-- System Health -->
                <div class="card dashboard-system-health">
                    <div class="flex-between">
                        <h3>System Health</h3>
                        <button class="btn btn-small btn-secondary" onclick="refreshSystemHealth()" title="Refresh health status">‚Üª</button>
                    </div>
                    <div id="system-health-content" class="mt-20">
                        <div class="skeleton">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GitLab Instances Tab -->
        <div id="instances-tab" class="tab-content">
            <div class="card">
                <h2>GitLab Instances</h2>
                <p class="text-muted">Configure GitLab instances that will be used for mirroring.</p>

                <form id="instance-form" class="mt-20">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="instance-name">Name *</label>
                            <input type="text" id="instance-name" name="name" required placeholder="e.g., Production GitLab">
                        </div>
                        <div class="form-group">
                            <label for="instance-url">URL *</label>
                            <input type="url" id="instance-url" name="url" required placeholder="https://gitlab.example.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="instance-token">Access Token *</label>
                        <input type="password" id="instance-token" name="token" required placeholder="Personal or group access token">
                    </div>

                    <div class="form-group">
                        <label for="instance-description">Description</label>
                        <textarea id="instance-description" name="description" placeholder="Optional description"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Add Instance</button>
                </form>
            </div>

            <div class="card">
                <div class="flex-between">
                    <h3>Configured Instances</h3>
                    <button class="btn btn-secondary btn-small" onclick="loadInstances()" title="Refresh instances list">‚Üª Refresh</button>
                </div>
                <table id="instances-table" class="enhanced-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>URL</th>
                            <th>Description</th>
                            <th>Access Token</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="instances-list">
                        <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Instance Pairs Tab -->
        <div id="pairs-tab" class="tab-content">
            <div class="card">
                <h2>Instance Pairs</h2>
                <p class="text-muted">Define pairs of GitLab instances for mirroring with default settings.</p>

                <form id="pair-form" class="mt-20">
                    <div class="form-group">
                        <label for="pair-name">Pair Name *</label>
                        <input type="text" id="pair-name" name="name" required placeholder="e.g., Prod to Backup">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pair-source-instance">Source Instance *</label>
                            <select id="pair-source-instance" name="source_instance_id" required>
                                <option value="">Select instance...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pair-target-instance">Target Instance *</label>
                            <select id="pair-target-instance" name="target_instance_id" required>
                                <option value="">Select instance...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pair-direction">Mirror Direction *</label>
                        <select id="pair-direction" name="mirror_direction" required>
                            <option value="pull">Pull (Target pulls from Source)</option>
                            <option value="push">Push (Source pushes to Target)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Default Mirror Settings</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="pair-overwrite" name="mirror_overwrite_diverged">
                            <label for="pair-overwrite">Overwrite divergent branches</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="pair-trigger" name="mirror_trigger_builds">
                            <label for="pair-trigger">Trigger builds on mirror update</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="pair-only-protected" name="only_mirror_protected_branches">
                            <label for="pair-only-protected">Only mirror protected branches</label>
                        </div>
                        <div class="form-row mt-10">
                            <div class="form-group">
                                <label for="pair-branch-regex">Mirror branch regex</label>
                                <input type="text" id="pair-branch-regex" name="mirror_branch_regex" placeholder="Optional (e.g., ^main$|^release/.*$)">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pair-description">Description</label>
                        <textarea id="pair-description" name="description" placeholder="Optional description"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Create Pair</button>
                </form>
            </div>

            <div class="card">
                <div class="flex-between">
                    <h3>Configured Pairs</h3>
                    <button class="btn btn-secondary btn-small" onclick="loadPairs()" title="Refresh pairs list">‚Üª Refresh</button>
                </div>
                <table id="pairs-table" class="enhanced-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Source</th>
                            <th>Target</th>
                            <th>Direction</th>
                            <th>Default Settings</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pairs-list">
                        <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mirrors Tab -->
        <div id="mirrors-tab" class="tab-content">
            <div class="card">
                <div class="flex-between">
                    <h2>Mirrors</h2>
                    <div class="flex">
                        <button class="btn btn-secondary btn-small" onclick="exportMirrors()" title="Download mirrors for selected pair as JSON">Export</button>
                        <button class="btn btn-secondary btn-small" onclick="importMirrors()" title="Upload JSON file to create mirrors for selected pair">Import</button>
                    </div>
                </div>
                <p class="text-muted">Manage mirrors for your instance pairs. <a href="#" onclick="switchTab('help-tab'); return false;" style="color: var(--info-color);">See Import/Export help ‚Üí</a></p>

                <div class="form-group mt-20">
                    <label for="pair-selector">Select Instance Pair *</label>
                    <select id="pair-selector">
                        <option value="">Select instance pair...</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h3>Create New Mirror</h3>
                <!-- Direction is inherited from the instance pair -->
                <form id="mirror-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="mirror-enabled" name="enabled" checked>
                                <label for="mirror-enabled">Enabled</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mirror-source-project-input">Source Project *</label>
                            <div class="autocomplete-wrapper" id="source-project-autocomplete">
                                <input type="text"
                                       id="mirror-source-project-input"
                                       class="autocomplete-input"
                                       placeholder="Type to search projects‚Ä¶"
                                       autocomplete="off">
                                <input type="hidden" id="mirror-source-project" name="source_project_id" required>
                                <div class="autocomplete-dropdown" id="source-project-dropdown"></div>
                            </div>
                            <div id="source-project-mirrors-badge" class="project-mirrors-badge"></div>
                            <div class="text-muted" style="margin-top: 6px;">Type to search, then select from the list.</div>
                        </div>
                        <div class="form-group">
                            <label for="mirror-target-project-input">Target Project *</label>
                            <div class="autocomplete-wrapper" id="target-project-autocomplete">
                                <input type="text"
                                       id="mirror-target-project-input"
                                       class="autocomplete-input"
                                       placeholder="Type to search projects‚Ä¶"
                                       autocomplete="off">
                                <input type="hidden" id="mirror-target-project" name="target_project_id" required>
                                <div class="autocomplete-dropdown" id="target-project-dropdown"></div>
                            </div>
                            <div id="target-project-mirrors-badge" class="project-mirrors-badge"></div>
                            <div class="text-muted" style="margin-top: 6px;">Type to search, then select from the list.</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Mirror Settings (optional overrides)</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mirror-overwrite">Overwrite divergent branches</label>
                                <select id="mirror-overwrite" name="mirror_overwrite_diverged" class="form-select">
                                    <option value="__inherit__" selected>Inherit from pair</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mirror-only-protected">Only mirror protected branches</label>
                                <select id="mirror-only-protected" name="only_mirror_protected_branches" class="form-select">
                                    <option value="__inherit__" selected>Inherit from pair</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mirror-trigger">Trigger builds (pull only)</label>
                                <select id="mirror-trigger" name="mirror_trigger_builds" class="form-select">
                                    <option value="__inherit__" selected>Inherit from pair</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row mt-10">
                            <div class="form-group">
                                <label for="mirror-branch-regex">Mirror branch regex (pull only)</label>
                                <input type="text" id="mirror-branch-regex" name="mirror_branch_regex" placeholder="Inherit from pair">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Mirror</button>
                </form>
            </div>

            <div class="card">
                <div class="flex-between">
                    <h3>Configured Mirrors</h3>
                    <div class="flex" style="gap:10px;">
                        <button class="btn btn-secondary btn-small" onclick="loadMirrors()" title="Refresh mirrors list">‚Üª Refresh</button>
                        <button class="btn btn-secondary btn-small" onclick="toggleMirrorViewMode()" title="Toggle between flat list and tree view">
                            <span id="view-mode-icon">üå≥</span> Tree View
                        </button>
                        <button id="verify-all-btn" class="btn btn-info btn-small" onclick="verifyAllMirrors()" title="Check all mirrors for orphan/drift issues">
                            Verify All
                        </button>
                        <button id="refresh-status-btn" class="btn btn-secondary btn-small" onclick="refreshAllMirrorStatus()" title="Refresh status from GitLab for all mirrors">
                            Refresh Status
                        </button>
                    </div>
                </div>

                <!-- Filter and sort controls -->
                <div class="mirror-controls mt-20 mb-10" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="mirror-group-filter" class="text-muted" style="margin-bottom:6px">Filter by group path</label>
                        <input type="text" id="mirror-group-filter" placeholder="e.g., group1/subgroup1" onchange="filterByGroupPath(this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="mirror-sort-by" class="text-muted" style="margin-bottom:6px">Sort by</label>
                        <select id="mirror-sort-by" onchange="changeMirrorSort(this.value, document.getElementById('mirror-sort-dir').value)">
                            <option value="created_at">Created Date</option>
                            <option value="updated_at">Updated Date</option>
                            <option value="source_project_path">Source Path</option>
                            <option value="target_project_path">Target Path</option>
                            <option value="last_update_status">Status</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="mirror-sort-dir" class="text-muted" style="margin-bottom:6px">Order</label>
                        <select id="mirror-sort-dir" onchange="changeMirrorSort(document.getElementById('mirror-sort-by').value, this.value)">
                            <option value="desc" selected>Descending</option>
                            <option value="asc">Ascending</option>
                        </select>
                    </div>
                </div>

                <table id="mirrors-table" class="enhanced-table">
                    <thead>
                        <tr>
                            <th>Source Project</th>
                            <th>Target Project</th>
                            <th>Effective Settings</th>
                            <th>Status</th>
                            <th>Sync Status</th>
                            <th>Last Sync</th>
                            <th>Token</th>
                            <th title="Orphan/drift detection status">Health</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mirrors-list">
                        <tr><td colspan="9" class="text-center text-muted">Select an instance pair to view mirrors</td></tr>
                    </tbody>
                </table>

                <!-- Pagination controls -->
                <div id="mirror-pagination" class="mt-20"></div>
            </div>
        </div>

        <!-- Topology Tab -->
        <div id="topology-tab" class="tab-content">
            <div class="card">
                <div class="flex-between">
                    <div>
                        <h2>Topology</h2>
                        <p class="text-muted">Visualize instance-to-instance mirror flows (aggregated by direction and count).</p>
                    </div>
                    <div class="flex" style="gap:10px; flex-wrap:wrap">
                        <button class="btn btn-secondary btn-small" type="button" id="topology-refresh-btn">Refresh</button>
                    </div>
                </div>

                <div class="topology-controls mt-20">
                    <div class="form-group" style="margin-bottom:0; min-width: 320px;">
                        <label for="topology-pair-filter" class="text-muted" style="margin-bottom:6px">Instance pair</label>
                        <select id="topology-pair-filter">
                            <option value="">All pairs</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:0; min-width: 210px;">
                        <label for="topology-stale-warn-hours" class="text-muted" style="margin-bottom:6px">Stale warning (hours)</label>
                        <input id="topology-stale-warn-hours" type="number" min="0" step="1" value="24">
                    </div>
                    <div class="form-group" style="margin-bottom:0; min-width: 210px;">
                        <label for="topology-stale-error-hours" class="text-muted" style="margin-bottom:6px">Stale error (hours)</label>
                        <input id="topology-stale-error-hours" type="number" min="0" step="1" value="168">
                    </div>
                    <label class="checkbox-group" style="margin-bottom:0">
                        <input type="checkbox" id="topology-never-succeeded-error">
                        <span>Never succeeded = error</span>
                    </label>
                    <label class="checkbox-group" style="margin-bottom:0">
                        <input type="checkbox" id="topology-show-pull" checked>
                        <span>Show pull</span>
                    </label>
                    <label class="checkbox-group" style="margin-bottom:0">
                        <input type="checkbox" id="topology-show-push" checked>
                        <span>Show push</span>
                    </label>
                    <label class="checkbox-group" style="margin-bottom:0">
                        <input type="checkbox" id="topology-show-disabled" checked>
                        <span>Include disabled mirrors</span>
                    </label>
                    <div class="text-muted" style="font-size:0.92rem">
                        Tip: drag nodes, scroll to zoom, click a node/edge for details.
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="topology-layout">
                    <div class="topology-canvas" id="topology-canvas">
                        <div class="text-muted text-center" id="topology-loading" style="padding:24px">
                            <div class="spinner"></div>
                        </div>
                        <div class="topology-zoom-controls">
                            <button id="topology-zoom-in" class="zoom-btn" title="Zoom in">+</button>
                            <button id="topology-zoom-reset" class="zoom-btn" title="Reset zoom">‚äô</button>
                            <button id="topology-zoom-out" class="zoom-btn" title="Zoom out">‚àí</button>
                        </div>
                    </div>
                    <aside class="topology-panel">
                        <div class="topology-panel-header">
                            <strong id="topology-panel-title">Details</strong>
                            <span class="text-muted" id="topology-panel-subtitle">Click a node or link</span>
                        </div>
                        <div class="topology-panel-body" id="topology-panel-body">
                            <div class="text-muted">No selection.</div>
                        </div>
                        <div class="topology-legend">
                            <div class="topology-legend-row">
                                <span class="topology-legend-swatch topology-swatch-pull"></span>
                                <span><strong>pull</strong> (target pulls from source)</span>
                            </div>
                            <div class="topology-legend-row">
                                <span class="topology-legend-swatch topology-swatch-push"></span>
                                <span><strong>push</strong> (source pushes to target)</span>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </div>

        <!-- Backup Tab -->
        <div id="backup-tab" class="tab-content">
            <div class="card">
                <h2>Backup & Restore</h2>
                <p class="text-muted">Create and restore complete backups of your Mirror Maestro database and encryption key.</p>
            </div>

            <!-- Create Backup -->
            <div class="card">
                <h3>üì¶ Create Backup</h3>
                <p>Download a complete backup of your Mirror Maestro configuration.</p>

                <div class="backup-info">
                    <div class="backup-stat-grid">
                        <div class="backup-stat">
                            <div class="backup-stat-label">GitLab Instances</div>
                            <div class="backup-stat-value" id="backup-stat-instances">-</div>
                        </div>
                        <div class="backup-stat">
                            <div class="backup-stat-label">Instance Pairs</div>
                            <div class="backup-stat-value" id="backup-stat-pairs">-</div>
                        </div>
                        <div class="backup-stat">
                            <div class="backup-stat-label">Mirrors</div>
                            <div class="backup-stat-value" id="backup-stat-mirrors">-</div>
                        </div>
                        <div class="backup-stat">
                            <div class="backup-stat-label">Database Size</div>
                            <div class="backup-stat-value" id="backup-stat-size">-</div>
                        </div>
                    </div>

                    <div class="backup-includes">
                        <p><strong>Backup includes:</strong></p>
                        <ul>
                            <li>All GitLab instances (with encrypted tokens)</li>
                            <li>All instance pairs (with default settings)</li>
                            <li>All mirrors (with configurations and status)</li>
                            <li>Encryption key (required to decrypt tokens)</li>
                        </ul>
                    </div>

                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Security Warning:</strong> Backup files contain your encryption key and can decrypt all stored GitLab tokens. Store backups securely and never share them publicly!
                    </div>
                </div>

                <button id="create-backup-btn" class="btn btn-primary">
                    <span id="create-backup-text">Create & Download Backup</span>
                    <span id="create-backup-spinner" class="btn-spinner" style="display:none;">
                        <div class="spinner"></div>
                    </span>
                </button>
            </div>

            <!-- Restore from Backup -->
            <div class="card">
                <h3>üì§ Restore from Backup</h3>
                <p>Restore your configuration from a backup file.</p>

                <div class="alert alert-danger">
                    <strong>‚ö†Ô∏è Warning:</strong> Restoring will REPLACE all current data including:
                    <ul>
                        <li>All GitLab instances</li>
                        <li>All instance pairs</li>
                        <li>All mirrors</li>
                        <li>The encryption key</li>
                    </ul>
                    This action cannot be undone. Make sure you have a current backup before proceeding.
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="backup-before-restore" checked>
                        Create backup before restore (recommended)
                    </label>
                    <p class="text-muted" style="margin-top: 8px;">
                        Automatically creates a backup of your current data before restoring.
                    </p>
                </div>

                <div class="backup-upload">
                    <input type="file" id="restore-file-input" accept=".tar.gz" style="display:none;">
                    <button id="select-backup-btn" class="btn btn-secondary">Select Backup File</button>
                    <span id="restore-filename" class="text-muted">No file selected</span>
                </div>

                <button id="restore-backup-btn" class="btn btn-danger" disabled>
                    <span id="restore-backup-text">Restore Backup</span>
                    <span id="restore-backup-spinner" class="btn-spinner" style="display:none;">
                        <div class="spinner"></div>
                    </span>
                </button>
            </div>

            <!-- Backup Information -->
            <div class="card">
                <h3>‚ÑπÔ∏è Backup Information</h3>
                <ul>
                    <li><strong>Format:</strong> Backups are compressed archives (.tar.gz)</li>
                    <li><strong>Portability:</strong> Compatible across Mirror Maestro versions and servers</li>
                    <li><strong>Migration:</strong> Can be used to migrate between different servers</li>
                    <li><strong>Security:</strong> Encryption key is included - keep backups safe!</li>
                    <li><strong>Automatic naming:</strong> Files are named <code>mirror-maestro-backup-YYYYMMDD-HHMMSS.tar.gz</code></li>
                </ul>

                <h4>Best Practices</h4>
                <ul>
                    <li>Create regular backups (daily or weekly depending on your change frequency)</li>
                    <li>Store backups in a secure location separate from your Mirror Maestro server</li>
                    <li>Test your backups periodically to ensure they can be restored</li>
                    <li>Keep multiple backup versions in case of corruption</li>
                    <li>Use encryption or access controls on your backup storage</li>
                </ul>
            </div>
        </div>

        <!-- Settings Tab (admin only) -->
        <div id="settings-tab" class="tab-content">
            <div class="card">
                <h2>User Management</h2>
                <p class="text-muted">Manage users who can access Mirror Maestro.</p>

                <form id="user-form" class="mt-20">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-username">Username *</label>
                            <input type="text" id="user-username" name="username" required placeholder="e.g., johndoe">
                        </div>
                        <div class="form-group">
                            <label for="user-email">Email</label>
                            <input type="email" id="user-email" name="email" placeholder="user@example.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="user-password">Password *</label>
                            <input type="password" id="user-password" name="password" required placeholder="Minimum 8 characters">
                        </div>
                        <div class="form-group">
                            <label for="user-password-confirm">Confirm Password *</label>
                            <input type="password" id="user-password-confirm" name="password_confirm" required placeholder="Confirm password">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="user-is-admin" name="is_admin">
                            <label for="user-is-admin">Administrator (can manage other users)</label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Create User</button>
                </form>
            </div>

            <div class="card">
                <h3>Users</h3>
                <table id="users-table" class="enhanced-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-list">
                        <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- About Tab -->
        <div id="about-tab" class="tab-content">
            <div class="card about-card">
                <div class="about-header">
                    <h1>Mirror Maestro</h1>
                    <p class="about-version">Version <span id="about-version">-</span></p>
                </div>

                <p class="about-description">
                    Orchestrate GitLab mirrors across multiple instance pairs with precision
                </p>

                <div class="about-section">
                    <h3>Project Information</h3>
                    <div class="about-links">
                        <a href="https://github.com/MrZoller/mirror-maestro" target="_blank" rel="noopener" class="about-link">
                            <span class="about-link-icon">üì¶</span>
                            <div>
                                <strong>GitHub Repository</strong>
                                <span class="text-muted">Source code and issues</span>
                            </div>
                        </a>
                        <a href="https://github.com/MrZoller/mirror-maestro#readme" target="_blank" rel="noopener" class="about-link">
                            <span class="about-link-icon">üìñ</span>
                            <div>
                                <strong>Documentation</strong>
                                <span class="text-muted">Setup and usage guide</span>
                            </div>
                        </a>
                        <a href="https://github.com/MrZoller/mirror-maestro/blob/main/LICENSE" target="_blank" rel="noopener" class="about-link">
                            <span class="about-link-icon">‚öñÔ∏è</span>
                            <div>
                                <strong>License</strong>
                                <span class="text-muted">MIT License</span>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="about-section">
                    <h3>Technology Stack</h3>
                    <div class="about-tech">
                        <span class="tech-badge">Python 3.11+</span>
                        <span class="tech-badge">FastAPI</span>
                        <span class="tech-badge">SQLAlchemy</span>
                        <span class="tech-badge">SQLite</span>
                        <span class="tech-badge">D3.js</span>
                    </div>
                </div>

                <div class="about-footer">
                    <p class="text-muted">
                        Built with ‚ù§Ô∏è for the GitLab community
                    </p>
                </div>
            </div>
        </div>

        <!-- Help Tab -->
        <div id="help-tab" class="tab-content">
            <!-- Getting Started -->
            <div class="card">
                <h2>Getting Started</h2>
                <p class="text-muted">Welcome to Mirror Maestro - your tool for orchestrating GitLab mirrors across multiple instances.</p>

                <h3>What is Mirror Maestro?</h3>
                <p>Mirror Maestro simplifies the management of GitLab repository mirrors. Whether you need to sync repositories between GitLab instances, create backups, or maintain read-only copies, Mirror Maestro provides a centralized interface to configure and monitor all your mirrors.</p>

                <h3>Application Overview</h3>
                <p>Mirror Maestro is organized into several tabs, each focused on a specific aspect of mirror management:</p>
                <ul>
                    <li><strong><a href="#" onclick="switchTab('dashboard-tab'); return false;">Dashboard</a></strong> - Quick overview with statistics, recent activity, and system health</li>
                    <li><strong><a href="#" onclick="switchTab('instances-tab'); return false;">GitLab Instances</a></strong> - Manage connections to your GitLab servers</li>
                    <li><strong><a href="#" onclick="switchTab('pairs-tab'); return false;">Instance Pairs</a></strong> - Configure mirroring relationships between instances</li>
                    <li><strong><a href="#" onclick="switchTab('mirrors-tab'); return false;">Mirrors</a></strong> - Create and manage individual repository mirrors</li>
                    <li><strong><a href="#" onclick="switchTab('topology-tab'); return false;">Topology</a></strong> - Visualize your mirror network with an interactive graph</li>
                    <li><strong><a href="#" onclick="switchTab('backup-tab'); return false;">Backup</a></strong> - Create and restore complete database backups</li>
                    <li><strong><a href="#" onclick="switchTab('about-tab'); return false;">About</a></strong> - Project information and version details</li>
                    <li><strong><a href="#" onclick="switchTab('help-tab'); return false;">Help</a></strong> - This comprehensive guide</li>
                </ul>

                <h3>Core Concepts</h3>
                <ul>
                    <li><strong>GitLab Instances</strong> - Your GitLab servers (self-hosted or GitLab.com). Each instance needs an access token with API permissions.</li>
                    <li><strong>Instance Pairs</strong> - A connection between two instances (or the same instance) that defines the mirroring direction and default settings.</li>
                    <li><strong>Mirrors</strong> - Individual repository mirrors that sync content from a source project to a target project.</li>
                </ul>

                <h3>Quick Start: Create Your First Mirror</h3>
                <ol>
                    <li><strong>Add a GitLab Instance</strong> - Go to <a href="#" onclick="switchTab('instances-tab'); return false;">GitLab Instances</a> and add your GitLab server with an access token.</li>
                    <li><strong>Create an Instance Pair</strong> - Go to <a href="#" onclick="switchTab('pairs-tab'); return false;">Instance Pairs</a> and create a pair (can be the same instance for internal mirroring).</li>
                    <li><strong>Create a Mirror</strong> - Go to <a href="#" onclick="switchTab('mirrors-tab'); return false;">Mirrors</a>, select your pair, choose source and target projects, and create the mirror. Authentication tokens are managed automatically.</li>
                </ol>
            </div>

            <!-- GitLab Instances -->
            <div class="card">
                <h2>GitLab Instances</h2>
                <p class="text-muted">Configure connections to your GitLab servers.</p>

                <h3>Required Token Permissions</h3>
                <p>The instance access token needs the following scopes:</p>
                <ul>
                    <li><strong>api</strong> - Full API access (required for creating and managing mirrors)</li>
                    <li><strong>read_repository</strong> - Read access to repositories (for pull mirrors)</li>
                    <li><strong>write_repository</strong> - Write access to repositories (for push mirrors)</li>
                </ul>
                <p>You can use a Personal Access Token (PAT) or a Project/Group Access Token with these scopes.</p>

                <h3>Adding an Instance</h3>
                <ol>
                    <li>Navigate to the <a href="#" onclick="switchTab('instances-tab'); return false;">GitLab Instances</a> tab</li>
                    <li>Fill in the instance name (e.g., "Production GitLab")</li>
                    <li>Enter the instance URL (e.g., <code>https://gitlab.example.com</code>)</li>
                    <li>Paste your access token</li>
                    <li>Click "Add Instance" - the connection will be tested automatically</li>
                </ol>

                <h3>Testing Connections</h3>
                <p>After adding an instance, Mirror Maestro verifies the token by fetching the authenticated user's information. If successful, you'll see the API username displayed in the instances table.</p>

                <h3>Deletion Behavior</h3>
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Important:</strong> Deleting a GitLab instance performs a cascading delete with GitLab cleanup.
                </div>
                <p>When you delete an instance, the following happens:</p>
                <ol>
                    <li><strong>GitLab Cleanup</strong> - All mirrors and project access tokens are removed from GitLab using rate-limited API calls</li>
                    <li><strong>Database Cleanup</strong> - Instance pairs referencing this instance and their associated mirrors are deleted from the database</li>
                    <li><strong>Progress Tracking</strong> - The operation returns detailed metrics showing successful and failed cleanup operations</li>
                </ol>
                <p><strong>Rate Limiting:</strong> For instances with many mirrors, cleanup operations are throttled (default: 200ms between operations) to avoid overwhelming GitLab.</p>
                <p><strong>Best-Effort:</strong> If GitLab cleanup fails for some mirrors (e.g., network errors, expired tokens), the database deletion still proceeds, and warnings are returned.</p>
            </div>

            <!-- Instance Pairs -->
            <div class="card">
                <h2>Instance Pairs</h2>
                <p class="text-muted">Define mirroring relationships between GitLab instances.</p>

                <h3>Push vs Pull Mirroring</h3>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Direction</th>
                            <th>Use Case</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Push</strong></td>
                            <td>Source ‚Üí Target</td>
                            <td>The source repository pushes changes to the target. Best for active development repos pushing to backups or read-only copies.</td>
                        </tr>
                        <tr>
                            <td><strong>Pull</strong></td>
                            <td>Target ‚Üê Source</td>
                            <td>The target repository pulls changes from the source. Best when you want the target to control when it syncs.</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Creating a Pair</h3>
                <ol>
                    <li>Navigate to the <a href="#" onclick="switchTab('pairs-tab'); return false;">Instance Pairs</a> tab</li>
                    <li>Enter a descriptive name (e.g., "Dev to Prod Sync")</li>
                    <li>Select the source and target instances</li>
                    <li>Choose the mirror direction (push or pull)</li>
                    <li>Configure default settings for mirrors in this pair</li>
                    <li>Click "Create Pair"</li>
                </ol>

                <h3>Pair-Level Default Settings</h3>
                <p>Settings configured on a pair become defaults for all mirrors in that pair. Individual mirrors can override these settings.</p>
                <ul>
                    <li><strong>Mirror protected branches only</strong> - Only sync branches that are protected</li>
                    <li><strong>Trigger builds</strong> - Run CI/CD pipelines on the target after sync</li>
                    <li><strong>Overwrite diverged branches</strong> - Force-update branches that have diverged</li>
                </ul>

                <h3>Bidirectional Mirroring</h3>
                <p>To sync repositories in both directions between two instances, create two instance pairs:</p>
                <ul>
                    <li><strong>Pair 1:</strong> Instance A ‚Üí Instance B (e.g., "Production to Staging")</li>
                    <li><strong>Pair 2:</strong> Instance B ‚Üí Instance A (e.g., "Staging to Production")</li>
                </ul>
                <p>Each pair can have independent settings (direction, branch filters, overwrite policies, etc.). The <a href="#" onclick="switchTab('topology-tab'); return false;">Topology</a> view will display both directions as separate links between the instances, making bidirectional relationships easy to visualize.</p>

                <h3>Batch Mirror Sync</h3>
                <p>The "Sync All" button in the Instance Pairs table allows you to trigger sync for all enabled mirrors in a pair with a single click. This is particularly useful when:</p>
                <ul>
                    <li><strong>Resuming after outages</strong> - When a GitLab instance goes down temporarily, all mirrors may stop syncing and need manual resumption</li>
                    <li><strong>Post-maintenance sync</strong> - After scheduled maintenance or upgrades</li>
                    <li><strong>Large-scale updates</strong> - When you need to sync hundreds of mirrors at once</li>
                </ul>

                <h4>How Batch Sync Works</h4>
                <p>When you click "Sync All", Mirror Maestro:</p>
                <ol>
                    <li>Fetches all enabled mirrors for the selected pair</li>
                    <li>Sequentially triggers each mirror's sync operation</li>
                    <li>Applies rate limiting between operations (default: 200ms delay)</li>
                    <li>Continues processing even if some mirrors fail</li>
                    <li>Returns a detailed summary with success/failure counts and timing metrics</li>
                </ol>

                <h4>Rate Limiting Protection</h4>
                <p>To prevent overwhelming GitLab instances with too many API requests, batch operations use intelligent rate limiting:</p>
                <ul>
                    <li><strong>Configurable delay</strong> - Default 200ms between operations (~300 requests/minute, well under GitLab's typical 600/min limit)</li>
                    <li><strong>Automatic retry</strong> - If GitLab returns a 429 "Too Many Requests" error, operations are retried with exponential backoff</li>
                    <li><strong>Progress tracking</strong> - Real-time progress with estimated completion time</li>
                    <li><strong>Detailed reporting</strong> - Shows which mirrors succeeded, failed, or were skipped</li>
                </ul>

                <h4>Example: Syncing 100 Mirrors</h4>
                <pre style="background: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto;"><code>With default settings (200ms delay):
- Total time: ~20 seconds
- Rate: ~300 operations/minute
- Well under GitLab's API limits
- Safe for large mirror sets</code></pre>

                <h3>Deletion Behavior</h3>
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Important:</strong> Deleting an instance pair performs a cascading delete with GitLab cleanup.
                </div>
                <p>When you delete a pair, the following happens:</p>
                <ol>
                    <li><strong>GitLab Cleanup</strong> - All mirrors in the pair and their project access tokens are removed from GitLab using rate-limited API calls</li>
                    <li><strong>Database Cleanup</strong> - The pair and all associated mirrors are deleted from the database</li>
                    <li><strong>Progress Tracking</strong> - Returns detailed metrics showing successful and failed cleanup operations</li>
                </ol>
                <p><strong>Rate Limiting:</strong> For pairs with many mirrors, cleanup operations are throttled to avoid overwhelming GitLab (same rate limiting as batch sync).</p>
                <p><strong>Best-Effort:</strong> If GitLab cleanup fails for some mirrors, the database deletion still proceeds with warnings returned.</p>

                <h4>Example: Deleting Pair with 50 Mirrors</h4>
                <pre style="background: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto;"><code>Each mirror deletion = 2 GitLab API calls:
1. Delete mirror from project
2. Delete project access token

Total operations: 100 API calls
With 200ms delay: ~20 seconds total
Safe and controlled cleanup</code></pre>
            </div>

            <!-- Authentication & Tokens -->
            <div class="card">
                <h2>Authentication</h2>
                <p class="text-muted">How Mirror Maestro handles mirror authentication.</p>

                <h3>Automatic Token Management</h3>
                <p>Mirror Maestro automatically creates and manages project access tokens for each mirror. When you create a mirror, a token is generated on the appropriate project with the required permissions.</p>
                <ul>
                    <li><strong>Push mirrors</strong> - Token is created on the <em>target</em> project (with <code>write_repository</code> scope)</li>
                    <li><strong>Pull mirrors</strong> - Token is created on the <em>source</em> project (with <code>read_repository</code> scope)</li>
                </ul>

                <h3>Token Expiration</h3>
                <p>Tokens are created with a 1-year expiration. The mirror list shows token status:</p>
                <ul>
                    <li><span class="badge badge-success">Active</span> - Token is valid</li>
                    <li><span class="badge badge-warning">Expiring Soon</span> - Token expires within 30 days</li>
                    <li><span class="badge badge-danger">Expired</span> - Token has expired and needs rotation</li>
                </ul>

                <h3>Token Rotation</h3>
                <p>To rotate a token before it expires (or after it has expired), click the "Rotate Token" button on the mirror. This will create a new token and update the mirror configuration automatically.</p>
            </div>

            <!-- Settings Hierarchy -->
            <div class="card">
                <h2>Settings Hierarchy</h2>
                <p class="text-muted">How mirror settings are resolved.</p>

                <h3>Two-Tier Resolution</h3>
                <p>Mirror settings are resolved in this order (first non-null value wins):</p>
                <ol>
                    <li><strong>Mirror-level</strong> - Settings on the individual mirror (highest priority)</li>
                    <li><strong>Pair-level</strong> - Default settings on the instance pair (fallback)</li>
                </ol>
                <p>This allows you to set sensible defaults on the instance pair and override them per-mirror as needed.</p>
            </div>

            <!-- Creating Mirrors -->
            <div class="card">
                <h2>Creating Mirrors</h2>
                <p class="text-muted">Step-by-step guide to setting up repository mirrors.</p>

                <h3>Prerequisites</h3>
                <ul>
                    <li>At least one GitLab instance configured</li>
                    <li>An instance pair created</li>
                    <li>A group token for the source and/or target groups</li>
                    <li>Source and target projects must exist (Mirror Maestro doesn't create projects)</li>
                </ul>

                <h3>Creating a Mirror</h3>
                <ol>
                    <li>Navigate to the <a href="#" onclick="switchTab('mirrors-tab'); return false;">Mirrors</a> tab</li>
                    <li>Select an instance pair from the dropdown</li>
                    <li>Search and select the source project</li>
                    <li>Search and select the target project</li>
                    <li>Click "Preflight Check" to validate the configuration</li>
                    <li>Review the effective settings shown in the preflight results</li>
                    <li>Click "Create Mirror" to set up the mirror on GitLab</li>
                </ol>

                <h3>Preflight Checks</h3>
                <p>Before creating a mirror, the preflight check verifies:</p>
                <ul>
                    <li>Both projects are accessible</li>
                    <li>Required tokens are available</li>
                    <li>The effective mirror settings (combining mirror, group, and pair defaults)</li>
                </ul>

                <h3>Mirror Settings</h3>
                <ul>
                    <li><strong>Enabled</strong> - Toggle to enable/disable the mirror without deleting it</li>
                    <li><strong>Only protected branches</strong> - Sync only branches marked as protected</li>
                    <li><strong>Trigger builds</strong> - Run CI/CD on target after successful sync</li>
                    <li><strong>Overwrite diverged</strong> - Force-push if target has diverged from source</li>
                </ul>

                <h3>Syncing Mirrors</h3>
                <p>Mirrors sync automatically based on GitLab's schedule (typically every 5 minutes for push, on-demand for pull). You can manually trigger a sync using the "Update Now" button in the mirrors table.</p>
            </div>

            <!-- Topology View -->
            <div class="card">
                <h2>Topology View</h2>
                <p class="text-muted">Visualize your mirror network with an interactive graph.</p>

                <h3>Understanding the Graph</h3>
                <ul>
                    <li><strong>Nodes</strong> - Each node represents a GitLab instance</li>
                    <li><strong>Links</strong> - Lines between nodes represent instance pairs</li>
                    <li><strong>Link colors</strong> - Blue for pull mirrors, orange for push mirrors</li>
                    <li><strong>Link thickness</strong> - Thicker links have more mirrors</li>
                </ul>

                <h3>Interacting with the Graph</h3>
                <ul>
                    <li><strong>Drag nodes</strong> - Rearrange the layout by dragging instances</li>
                    <li><strong>Click a node</strong> - See instance details and statistics</li>
                    <li><strong>Click a link</strong> - View all mirrors for that pair</li>
                    <li><strong>Zoom</strong> - Scroll to zoom in/out</li>
                    <li><strong>Pan</strong> - Click and drag the background to pan</li>
                </ul>

                <h3>Status Indicators</h3>
                <p>The graph shows mirror health at a glance:</p>
                <ul>
                    <li><strong>Green</strong> - All mirrors syncing successfully</li>
                    <li><strong>Yellow</strong> - Some mirrors have warnings or are stale</li>
                    <li><strong>Red</strong> - Mirrors have errors that need attention</li>
                </ul>
            </div>

            <!-- Import/Export -->
            <div class="card">
                <h2>Import/Export</h2>
                <p class="text-muted">Bulk manage mirror configurations with portable JSON files.</p>

                <h3>How to Use</h3>
                <ol>
                    <li>Navigate to the <a href="#" onclick="switchTab('mirrors-tab'); return false;">Mirrors</a> tab</li>
                    <li>Select an instance pair from the dropdown</li>
                    <li>Click <strong>Export</strong> to download all mirrors for that pair as JSON</li>
                    <li>Click <strong>Import</strong> to upload a JSON file and create mirrors</li>
                </ol>

                <h3>Export Format</h3>
                <p>Exports are <strong>portable across environments</strong> (dev/staging/prod):</p>
                <ul>
                    <li><strong>Project paths</strong> (not IDs) - e.g., <code>group/subgroup/project</code></li>
                    <li><strong>Mirror settings</strong> - All configuration options (overwrite diverged, protected branches, etc.)</li>
                    <li><strong>Metadata</strong> (informational only) - Source/target instances, direction, export timestamp</li>
                </ul>

                <h3>What Happens During Import</h3>
                <p>When you import a JSON file, Mirror Maestro performs these steps for each mirror:</p>
                <ol>
                    <li><strong>Looks up project IDs</strong> from paths via GitLab API</li>
                    <li><strong>Creates project access tokens</strong> in GitLab</li>
                    <li><strong>Creates actual mirrors</strong> in GitLab (push or pull)</li>
                    <li><strong>Stores mirror records</strong> in the database</li>
                    <li><strong>Applies rate limiting</strong> - Waits 200ms before processing the next mirror</li>
                </ol>
                <p class="alert alert-info"><strong>Note:</strong> The result is <em>identical to creating mirrors via the UI</em>. This is not just a database import - it creates real, functional GitLab mirrors with authentication tokens.</p>

                <h4>Import Rate Limiting</h4>
                <p>Importing many mirrors can generate hundreds of GitLab API requests (each mirror requires ~4 API calls). To prevent overwhelming your GitLab instances:</p>
                <ul>
                    <li><strong>Sequential processing</strong> - Mirrors are created one at a time, not in parallel</li>
                    <li><strong>Automatic delays</strong> - 200ms delay between each mirror (configurable)</li>
                    <li><strong>Retry logic</strong> - Automatic retry with exponential backoff on rate limit errors</li>
                    <li><strong>Progress metrics</strong> - Import results include duration and operations/second</li>
                </ul>
                <p><strong>Example:</strong> Importing 100 mirrors takes approximately 40-60 seconds with default settings, processing at a safe rate of ~200-300 API requests/minute.</p>

                <h3>Import Results</h3>
                <p>After import completes, you'll see a detailed summary:</p>
                <ul>
                    <li><strong>Imported count</strong> - Successfully created mirrors</li>
                    <li><strong>Skipped count</strong> - Mirrors that already exist</li>
                    <li><strong>Skipped details</strong> - Which mirrors were skipped and why (e.g., <code>[1/10] group/existing ‚Üí mirror/existing: Already exists in database</code>)</li>
                    <li><strong>Errors</strong> - Detailed list of failures with specific project paths (e.g., <code>[3/10] bad/project ‚Üí mirror/bad: Project not found</code>)</li>
                </ul>

                <h3>Important Notes</h3>
                <ul>
                    <li><strong>Select the correct pair</strong> - Import creates mirrors for the currently selected pair, not the pair from the export file</li>
                    <li><strong>Metadata is ignored</strong> - Only the <code>mirrors</code> array is used during import</li>
                    <li><strong>Projects must exist</strong> - Both source and target projects must already exist in their respective GitLab instances</li>
                    <li><strong>Duplicates are skipped</strong> - If a mirror already exists (same source/target paths), it won't be created again</li>
                    <li><strong>Import continues on errors</strong> - If some mirrors fail, others will still be imported</li>
                    <li><strong>Use full project paths</strong> - Paths must be in format <code>namespace/project</code> or <code>group/subgroup/project</code> (not just project names)</li>
                </ul>

                <h3>Example Export Structure</h3>
                <pre style="background: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto;"><code>{
  "metadata": {
    "exported_at": "2024-01-15T10:30:00Z",
    "pair_name": "GitLab.com ‚Üí Self-hosted",
    "source_instance_name": "GitLab.com",
    "target_instance_name": "Self-hosted",
    "mirror_direction": "push",
    "total_mirrors": 2
  },
  "mirrors": [
    {
      "source_project_path": "mygroup/project1",
      "target_project_path": "mirrors/project1",
      "mirror_overwrite_diverged": false,
      "only_mirror_protected_branches": true,
      "enabled": true
    }
  ]
}</code></pre>
            </div>

            <!-- Backup & Restore -->
            <div class="card">
                <h2>Backup & Restore</h2>
                <p class="text-muted">Protect your Mirror Maestro configuration with backups.</p>

                <h3>Creating Backups</h3>
                <p>Regular backups protect against data loss from database corruption, accidental deletion, or server failures.</p>
                <ol>
                    <li>Navigate to the <a href="#" onclick="switchTab('backup-tab'); return false;">Backup</a> tab</li>
                    <li>Review the current database statistics (instances, pairs, mirrors, size)</li>
                    <li>Click "Create & Download Backup" to download a complete backup</li>
                    <li>Save the backup file (.tar.gz) to a secure location</li>
                </ol>

                <h3>What's Included in Backups</h3>
                <p>Each backup archive contains:</p>
                <ul>
                    <li><strong>Database</strong> - All instances, pairs, mirrors, and configurations</li>
                    <li><strong>Encryption key</strong> - Required to decrypt stored GitLab tokens</li>
                    <li><strong>Metadata</strong> - Timestamp and version information</li>
                </ul>

                <h3>Restoring from Backup</h3>
                <p><strong>‚ö†Ô∏è Warning:</strong> Restoring replaces ALL current data. Always create a backup first!</p>
                <ol>
                    <li>Navigate to the <a href="#" onclick="switchTab('backup-tab'); return false;">Backup</a> tab</li>
                    <li>Ensure "Create backup before restore" is checked (recommended)</li>
                    <li>Click "Select Backup File" and choose your backup (.tar.gz)</li>
                    <li>Click "Restore Backup" and confirm the action</li>
                    <li>The application will reload with the restored data</li>
                </ol>

                <h3>Backup Best Practices</h3>
                <ul>
                    <li>Create backups regularly (daily or weekly recommended)</li>
                    <li>Store backups in a secure location separate from your server</li>
                    <li>Keep multiple backup versions (e.g., last 7 days)</li>
                    <li>Test restores periodically to verify backup integrity</li>
                    <li>Protect backup files - they contain encryption keys for all tokens</li>
                </ul>

                <h3>Migration Between Servers</h3>
                <p>Backups can be used to migrate Mirror Maestro to a new server:</p>
                <ol>
                    <li>Create a backup on the old server</li>
                    <li>Install Mirror Maestro on the new server</li>
                    <li>Upload and restore the backup on the new server</li>
                    <li>All instances, pairs, and mirrors will be migrated</li>
                </ol>
            </div>

            <!-- Mirror Verification -->
            <div class="card">
                <h2>Mirror Verification</h2>
                <p class="text-muted">Detect externally modified or deleted mirrors.</p>

                <h3>Why Verify Mirrors?</h3>
                <p>Mirrors created through Mirror Maestro may be modified or deleted directly in GitLab by other users. Verification helps you detect:</p>
                <ul>
                    <li><strong>Orphan mirrors</strong> - Mirror was deleted from GitLab but still exists in Mirror Maestro's database</li>
                    <li><strong>Drifted mirrors</strong> - Mirror settings on GitLab no longer match what Mirror Maestro expects</li>
                </ul>

                <h3>How to Verify</h3>
                <ol>
                    <li>Navigate to the <a href="#" onclick="switchTab('mirrors-tab'); return false;">Mirrors</a> tab</li>
                    <li>Select an instance pair from the dropdown</li>
                    <li>Click <strong>Verify All</strong> to check all visible mirrors, or click <strong>Verify</strong> on individual rows</li>
                </ol>

                <h3>Verification Status</h3>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Meaning</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge badge-success">‚úì</span></td>
                            <td>Healthy - Mirror exists on GitLab with matching settings</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-danger">Orphan</span></td>
                            <td>Mirror was deleted from GitLab externally. Consider deleting from Mirror Maestro.</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-warning">Drift</span></td>
                            <td>Settings mismatch. Hover for details. You may want to re-sync the settings.</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-secondary">N/C</span></td>
                            <td>Not Created - Mirror record exists but was never created on GitLab</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-danger">Err</span></td>
                            <td>Verification error - Could not contact GitLab. Check instance connectivity.</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Settings Checked for Drift</h3>
                <ul>
                    <li><code>enabled</code> - Whether the mirror is active</li>
                    <li><code>only_protected_branches</code> - Branch filtering</li>
                    <li><code>keep_divergent_refs</code> - How to handle diverged branches</li>
                    <li><code>trigger_builds</code> - CI trigger setting (pull mirrors only)</li>
                    <li><code>mirror_branch_regex</code> - Branch regex filter (pull mirrors only)</li>
                </ul>

                <h3>External Mirror Indicator</h3>
                <p>When creating a new mirror, Mirror Maestro checks if the selected projects already have mirrors configured on GitLab:</p>
                <ul>
                    <li>Select a source or target project in the Create Mirror form</li>
                    <li>If mirrors exist, a warning badge appears: <span class="badge badge-warning">‚ö† 2 push, 1 pull</span></li>
                    <li>This helps you understand the current state before creating a new mirror</li>
                </ul>
                <p class="alert alert-info"><strong>Note:</strong> This checks GitLab directly, showing all mirrors on the project - including those created outside of Mirror Maestro.</p>
            </div>

            <!-- Issue Mirroring -->
            <div class="card">
                <h2>Issue Mirroring</h2>
                <p class="text-muted">Automatically sync issues, comments, labels, and attachments between mirrored repositories.</p>

                <h3>What is Issue Mirroring?</h3>
                <p>In addition to syncing repository code, Mirror Maestro can synchronize GitLab issues between source and target projects. This keeps issue trackers in sync across instances, making it perfect for:</p>
                <ul>
                    <li>Maintaining consistent issue tracking across dev/staging/prod environments</li>
                    <li>Creating backup copies of issue data alongside code mirrors</li>
                    <li>Consolidating issues from multiple instances into a central tracking system</li>
                </ul>

                <h3>Configuring Issue Syncing</h3>
                <ol>
                    <li>Navigate to the <a href="#" onclick="switchTab('mirrors-tab'); return false;">Mirrors</a> tab and click the "Issue Configs" button</li>
                    <li>Click "Create Issue Config" and select a mirror</li>
                    <li>Configure what to sync:
                        <ul>
                            <li><strong>Sync Comments</strong> - Mirror all issue comments and notes</li>
                            <li><strong>Sync Labels</strong> - Copy labels to target issues</li>
                            <li><strong>Sync Attachments</strong> - Download and upload issue attachments</li>
                            <li><strong>Sync Weight/Time Tracking</strong> - Copy issue weight, time estimates, and time spent</li>
                            <li><strong>Sync Closed Issues</strong> - Include closed/resolved issues in sync</li>
                        </ul>
                    </li>
                    <li>Set the sync interval (5-1440 minutes, default: 15 minutes)</li>
                    <li>Click "Create Config" to enable automatic syncing</li>
                </ol>

                <h3>Production-Ready Robustness</h3>
                <p>Mirror Maestro's issue syncing is built for reliability in production environments with the following features:</p>

                <h4>Circuit Breaker Protection</h4>
                <p>Prevents cascading failures when GitLab instances experience issues:</p>
                <ul>
                    <li>After 5 consecutive failures (configurable), the sync pauses automatically</li>
                    <li>Waits 60 seconds (configurable) before attempting recovery</li>
                    <li>Protects both your Mirror Maestro server and GitLab instances from overload</li>
                </ul>

                <h4>Automatic Retry with Backoff</h4>
                <p>Transient network errors don't stop your syncs:</p>
                <ul>
                    <li>Automatically retries failed operations up to 3 times</li>
                    <li>Uses exponential backoff (1s, 2s, 4s delays) to avoid overwhelming the API</li>
                    <li>Distinguishes between retryable errors (network) and permanent failures (permissions)</li>
                </ul>

                <h4>Progress Checkpointing</h4>
                <p>Large syncs can be interrupted and resumed without data loss:</p>
                <ul>
                    <li>Processes issues in batches of 50 (configurable)</li>
                    <li>Commits progress after each batch to the database</li>
                    <li>If interrupted, next sync resumes from where it left off</li>
                    <li>Perfect for syncing thousands of issues safely</li>
                </ul>

                <h4>Memory Management</h4>
                <p>Efficiently handles large repositories without exhausting resources:</p>
                <ul>
                    <li>Batched processing prevents loading all issues into memory at once</li>
                    <li>Streaming downloads for attachments</li>
                    <li>Pagination limits prevent API response overload (max 100 pages)</li>
                    <li>Maximum 10,000 issues per sync (configurable)</li>
                </ul>

                <h4>Attachment Safety</h4>
                <p>Protects against oversized file transfers:</p>
                <ul>
                    <li>Default 100MB limit per attachment (configurable)</li>
                    <li>Checks file size before downloading (via Content-Length header)</li>
                    <li>Validates actual content size after download</li>
                    <li>Set to 0 for unlimited size (use with caution)</li>
                </ul>

                <h4>Rate Limiting</h4>
                <p>Stays within GitLab's API quotas:</p>
                <ul>
                    <li>Automatic 200ms delay between operations (~300 ops/min)</li>
                    <li>Well under GitLab's 600 requests/min limit</li>
                    <li>Prevents API quota exhaustion even with large syncs</li>
                </ul>

                <h4>Graceful Shutdown</h4>
                <p>Safe deployment and maintenance:</p>
                <ul>
                    <li>Active sync jobs complete before shutdown</li>
                    <li>Configurable timeout (default: 300 seconds)</li>
                    <li>No data loss during restarts or deployments</li>
                    <li>Partially completed syncs resume on next run</li>
                </ul>

                <h3>Configuration Options</h3>
                <p>Advanced settings can be configured via environment variables:</p>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Setting</th>
                            <th>Default</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>CIRCUIT_BREAKER_FAILURE_THRESHOLD</code></td>
                            <td>5</td>
                            <td>Failures before circuit opens</td>
                        </tr>
                        <tr>
                            <td><code>CIRCUIT_BREAKER_RECOVERY_TIMEOUT</code></td>
                            <td>60</td>
                            <td>Seconds to wait before recovery attempt</td>
                        </tr>
                        <tr>
                            <td><code>MAX_ISSUES_PER_SYNC</code></td>
                            <td>10000</td>
                            <td>Maximum issues to process in one sync</td>
                        </tr>
                        <tr>
                            <td><code>MAX_PAGES_PER_REQUEST</code></td>
                            <td>100</td>
                            <td>Maximum API pagination pages</td>
                        </tr>
                        <tr>
                            <td><code>MAX_ATTACHMENT_SIZE_MB</code></td>
                            <td>100</td>
                            <td>Maximum attachment size in MB (0=unlimited)</td>
                        </tr>
                        <tr>
                            <td><code>ATTACHMENT_DOWNLOAD_TIMEOUT</code></td>
                            <td>30</td>
                            <td>Timeout for downloading attachments (seconds)</td>
                        </tr>
                        <tr>
                            <td><code>ISSUE_BATCH_SIZE</code></td>
                            <td>50</td>
                            <td>Issues per checkpoint batch</td>
                        </tr>
                        <tr>
                            <td><code>SYNC_SHUTDOWN_TIMEOUT</code></td>
                            <td>300</td>
                            <td>Max wait for syncs during shutdown (seconds)</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Monitoring Sync Status</h3>
                <p>Track your issue syncs in the Issue Configs view:</p>
                <ul>
                    <li><strong>Last Sync</strong> - Timestamp of most recent sync</li>
                    <li><strong>Status</strong> - Success, failed, or in progress</li>
                    <li><strong>Next Sync</strong> - When the next automatic sync will run</li>
                    <li><strong>Error Message</strong> - Details if sync failed</li>
                    <li><strong>Manual Trigger</strong> - Force immediate sync with "Trigger Sync" button</li>
                </ul>

                <h3>Best Practices</h3>
                <ul>
                    <li>Start with a short sync interval (15 min) for active projects</li>
                    <li>For initial syncs of large repos, consider disabling sync_existing_issues temporarily</li>
                    <li>Monitor attachment sizes - large files can slow syncs significantly</li>
                    <li>Use longer intervals (60+ min) for archived or infrequently updated projects</li>
                    <li>Check sync status regularly to catch configuration issues early</li>
                    <li>Increase batch size for repositories with thousands of issues to reduce overhead</li>
                </ul>
            </div>

            <!-- System Health -->
            <div class="card">
                <h2>System Health</h2>
                <p class="text-muted">Monitor the health of your Mirror Maestro installation.</p>

                <h3>Health Dashboard</h3>
                <p>The <a href="#" onclick="switchTab('dashboard-tab'); return false;">Dashboard</a> includes a System Health card that shows the overall status of your Mirror Maestro installation at a glance. Health status is calculated based on:</p>
                <ul>
                    <li><strong>Database connectivity</strong> - Ensures the database is accessible</li>
                    <li><strong>Mirror sync status</strong> - Checks for failed mirrors</li>
                    <li><strong>Token expiration</strong> - Monitors for expiring or expired tokens</li>
                </ul>

                <h3>Health Status Levels</h3>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Meaning</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge badge-success">Healthy</span></td>
                            <td>All systems operational. Database connected, mirrors syncing, tokens valid.</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-warning">Degraded</span></td>
                            <td>Some issues detected. May have failed mirrors, expiring tokens, or unreachable instances.</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-danger">Unhealthy</span></td>
                            <td>Critical issues. Database may be down, most mirrors failing, or other severe problems.</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Health API Endpoints</h3>
                <p>Mirror Maestro provides health check endpoints for monitoring tools and load balancers:</p>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Endpoint</th>
                            <th>Auth</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>GET /api/health/quick</code></td>
                            <td>No</td>
                            <td>Fast health check for load balancers. Returns immediately without checking dependencies.</td>
                        </tr>
                        <tr>
                            <td><code>GET /api/health</code></td>
                            <td>Yes</td>
                            <td>Detailed health check with component status, mirror statistics, and token expiration info.</td>
                        </tr>
                        <tr>
                            <td><code>GET /api/health?check_instances=true</code></td>
                            <td>Yes</td>
                            <td>Extended health check that also tests connectivity to all GitLab instances (slower).</td>
                        </tr>
                        <tr>
                            <td><code>GET /health</code></td>
                            <td>No</td>
                            <td>Legacy endpoint for backward compatibility.</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Monitoring Best Practices</h3>
                <ul>
                    <li>Use <code>/api/health/quick</code> for frequent polling (e.g., every 10 seconds)</li>
                    <li>Use <code>/api/health</code> for less frequent detailed checks (e.g., every minute)</li>
                    <li>Set up alerts for "degraded" or "unhealthy" status</li>
                    <li>Monitor token expiration warnings and rotate tokens before they expire</li>
                    <li>Check the Dashboard regularly to review mirror sync failures</li>
                </ul>
            </div>

            <!-- Troubleshooting -->
            <div class="card">
                <h2>Troubleshooting</h2>
                <p class="text-muted">Common issues and how to resolve them.</p>

                <h3>Connection Errors</h3>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Error</th>
                            <th>Cause</th>
                            <th>Solution</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>401 Unauthorized</code></td>
                            <td>Invalid or expired token</td>
                            <td>Regenerate the access token and update the instance configuration</td>
                        </tr>
                        <tr>
                            <td><code>403 Forbidden</code></td>
                            <td>Token lacks required scopes</td>
                            <td>Ensure the token has <code>api</code>, <code>read_repository</code>, and <code>write_repository</code> scopes</td>
                        </tr>
                        <tr>
                            <td><code>Connection refused</code></td>
                            <td>Network/firewall issue</td>
                            <td>Check that the GitLab instance is reachable from the Mirror Maestro server</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Mirror Sync Failures</h3>
                <table class="help-table">
                    <thead>
                        <tr>
                            <th>Error</th>
                            <th>Cause</th>
                            <th>Solution</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>Remote host key changed</code></td>
                            <td>SSH host key mismatch</td>
                            <td>Use HTTPS URLs instead of SSH, or update known hosts on GitLab server</td>
                        </tr>
                        <tr>
                            <td><code>Diverged branches</code></td>
                            <td>Target has commits not in source</td>
                            <td>Enable "Overwrite diverged branches" if you want to force-sync</td>
                        </tr>
                        <tr>
                            <td><code>Repository not found</code></td>
                            <td>Project deleted or moved</td>
                            <td>Update the mirror with the new project path or delete the mirror</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Checking Mirror Status</h3>
                <ol>
                    <li>Go to the <a href="#" onclick="switchTab('mirrors-tab'); return false;">Mirrors</a> tab</li>
                    <li>Find your mirror in the table</li>
                    <li>Check the "Status" column for the current state</li>
                    <li>Click "Details" or "Refresh Status" for more information</li>
                    <li>The "Last Sync" column shows when the mirror last synced successfully</li>
                </ol>

                <h3>Getting Help</h3>
                <p>If you encounter issues not covered here:</p>
                <ul>
                    <li>Check the GitLab project's mirror settings directly in the GitLab UI</li>
                    <li>Review GitLab's documentation on <a href="https://docs.gitlab.com/ee/user/project/repository/mirror/" target="_blank" rel="noopener">repository mirroring</a></li>
                    <li>Open an issue on the <a href="https://github.com/MrZoller/mirror-maestro/issues" target="_blank" rel="noopener">Mirror Maestro GitHub repository</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="closeLoginModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sign In</h2>
                <button class="modal-close" onclick="closeLoginModal()" aria-label="Close">&times;</button>
            </div>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="login-username">Username</label>
                    <input type="text" id="login-username" name="username" required autocomplete="username" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" name="password" required autocomplete="current-password" placeholder="Enter your password">
                </div>
                <div id="login-error" class="message message-error" style="display: none;"></div>
                <button type="submit" class="btn btn-primary" id="login-submit-btn" style="width: 100%;">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="closeChangePasswordModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Password</h2>
                <button class="modal-close" onclick="closeChangePasswordModal()" aria-label="Close">&times;</button>
            </div>
            <form id="change-password-form" onsubmit="handleChangePassword(event)">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" name="current_password" required autocomplete="current-password">
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" name="new_password" required autocomplete="new-password" placeholder="Minimum 8 characters">
                </div>
                <div class="form-group">
                    <label for="confirm-new-password">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" name="confirm_password" required autocomplete="new-password">
                </div>
                <div id="change-password-error" class="message message-error" style="display: none;"></div>
                <button type="submit" class="btn btn-primary" id="change-password-submit-btn" style="width: 100%;">
                    Change Password
                </button>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="closeEditUserModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <button class="modal-close" onclick="closeEditUserModal()" aria-label="Close">&times;</button>
            </div>
            <form id="edit-user-form" onsubmit="handleEditUser(event)">
                <input type="hidden" id="edit-user-id" name="id">
                <div class="form-group">
                    <label for="edit-user-username">Username</label>
                    <input type="text" id="edit-user-username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="edit-user-email">Email</label>
                    <input type="email" id="edit-user-email" name="email">
                </div>
                <div class="form-group">
                    <label for="edit-user-password">New Password (leave blank to keep current)</label>
                    <input type="password" id="edit-user-password" name="password" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="edit-user-is-admin" name="is_admin">
                        <label for="edit-user-is-admin">Administrator</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="edit-user-is-active" name="is_active" checked>
                        <label for="edit-user-is-active">Active</label>
                    </div>
                </div>
                <div id="edit-user-error" class="message message-error" style="display: none;"></div>
                <button type="submit" class="btn btn-primary" id="edit-user-submit-btn" style="width: 100%;">
                    Save Changes
                </button>
            </form>
        </div>
    </div>

    <!-- Issue Mirroring Configuration Modal -->
    <div id="issue-mirror-config-modal" class="modal" style="display: none;">
        <div class="modal-backdrop" onclick="closeIssueMirrorConfigModal()"></div>
        <div class="modal-content sync-config-modal">
            <div class="modal-header">
                <h2>Issue Mirroring Configuration</h2>
                <button class="modal-close" onclick="closeIssueMirrorConfigModal()" aria-label="Close">&times;</button>
            </div>
            <form id="issue-mirror-config-form" onsubmit="handleIssueMirrorConfig(event)">
                <input type="hidden" id="issue-config-mirror-id" name="mirror_id">
                <input type="hidden" id="issue-config-id" name="config_id">

                <!-- Master toggle -->
                <div class="sync-toggle-row">
                    <div class="sync-toggle-info">
                        <span class="sync-toggle-label">Enable Issue Synchronization</span>
                        <span class="sync-toggle-desc">One-way sync from source to target project</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="issue-sync-enabled" name="enabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Sync Options Section -->
                <fieldset class="sync-section">
                    <legend class="sync-section-legend">Sync Options</legend>
                    <div class="sync-options-grid">
                        <label class="sync-option">
                            <input type="checkbox" id="issue-sync-comments" name="sync_comments" checked>
                            <span class="sync-option-text">Comments</span>
                        </label>
                        <label class="sync-option">
                            <input type="checkbox" id="issue-sync-labels" name="sync_labels" checked>
                            <span class="sync-option-text">Labels</span>
                        </label>
                        <label class="sync-option">
                            <input type="checkbox" id="issue-sync-attachments" name="sync_attachments" checked>
                            <span class="sync-option-text">Attachments</span>
                        </label>
                        <label class="sync-option">
                            <input type="checkbox" id="issue-sync-weight" name="sync_weight" checked>
                            <span class="sync-option-text">Weight</span>
                        </label>
                        <label class="sync-option">
                            <input type="checkbox" id="issue-sync-time-estimate" name="sync_time_estimate" checked>
                            <span class="sync-option-text">Time Estimate</span>
                        </label>
                        <label class="sync-option">
                            <input type="checkbox" id="issue-sync-time-spent" name="sync_time_spent" checked>
                            <span class="sync-option-text">Time Spent</span>
                        </label>
                        <label class="sync-option">
                            <input type="checkbox" id="issue-sync-closed" name="sync_closed_issues">
                            <span class="sync-option-text">Closed Issues</span>
                        </label>
                    </div>
                    <p class="sync-section-hint">Labels also syncs milestones, iterations, epics, and assignees as informational labels.</p>
                </fieldset>

                <!-- Sync Behavior Section -->
                <fieldset class="sync-section">
                    <legend class="sync-section-legend">Sync Behavior</legend>
                    <label class="sync-behavior-item">
                        <input type="checkbox" id="issue-update-existing" name="update_existing" checked>
                        <div class="sync-behavior-text">
                            <span class="sync-behavior-label">Update Existing Issues</span>
                            <span class="sync-behavior-desc">Keep previously synced issues up to date</span>
                        </div>
                    </label>
                    <label class="sync-behavior-item">
                        <input type="checkbox" id="issue-sync-existing" name="sync_existing_issues">
                        <div class="sync-behavior-text">
                            <span class="sync-behavior-label">Sync Existing Issues</span>
                            <span class="sync-behavior-desc">Include issues created before sync was enabled</span>
                        </div>
                    </label>
                    <div class="sync-interval-row">
                        <label for="issue-sync-interval" class="sync-interval-label">Sync Interval</label>
                        <div class="sync-interval-input">
                            <input type="number" id="issue-sync-interval" name="sync_interval_minutes" value="15" min="5" max="1440">
                            <span class="sync-interval-unit">min</span>
                        </div>
                    </div>
                </fieldset>

                <div id="issue-config-status" class="sync-status-bar"></div>
                <div id="issue-config-error" class="message message-error" style="display: none;"></div>

                <div class="sync-config-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeIssueMirrorConfigModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="issue-config-submit-btn">Save Configuration</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    {% if use_local_vendor_assets %}
    <script src="/static/vendor/d3.min.js"></script>
    {% else %}
    <script src="{{ cdn_d3js_url }}"></script>
    {% endif %}
    <script src="/static/js/topology.js"></script>
</body>
</html>
